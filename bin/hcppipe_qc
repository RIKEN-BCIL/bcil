#! /bin/bash

# Create report.html for checking quality of HCP pipeline outputs
# Takuya Hayashi, RIKEN BDR
# Copyright (c) 2022- RIKEN

# StructuralQC.scene was created by modifying a software, Human Connectome Project [StructuralQC].
# Copyright (c) 2011-2016 [The Human Connectome Project][HCP]

set -euo pipefail

VERSION=1.0

BCILDIR=$(cd $(dirname $0); cd ..; pwd)
source $BCILDIR/bcilconf/settings.sh

# Need to set the following variables in $BCILDIR/bcilconf/settings.sh:
# CARET7DIR
# HCPPIPEDIR
# FREESURFER_HOME
# FSLDIR
# DVARSDIR

# Requirements:
#  Matlab >=2022b
#  ImageMagick
#  jq
#  R (r-base-core)
#  Connectome workbench
#  FreeSurfer>= 6.0
#  FSL 6.0
#  HCP pipeline >= 4.3
#  DVARS https://github.com/asoroosh/DVARS


# Check if ImageMagick is installed (for convert)
if [[ $(which convert 2>/dev/null ) = "" ]] ; then
 	echo "ERROR: cannot find 'convert' in the system. Please install imagemagick."
	exit 1;
fi
if [[ $(which jq 2>/dev/null ) = "" ]] ; then
 	echo "ERROR: cannot find 'jq' in the system. Please install jq."
	exit 1;
fi
if [[ $(which zipmerge 2>/dev/null ) = "" ]] ; then
 	echo "WARNING: cannot find 'zipmerge'. You cannot zip archive if you use -z option."
else
	ZipMerge=ON
fi

Usage_exit () {

 echo ""
 echo " QC for HCP pipeline data"
 echo ""
 echo " Usage 1: hcppipe_qc <Study Folder> <Subject ID> <arguments>"
 echo ""
 echo " Compulsory arguments (any one or more of):" 
 echo "    -s : Structural QC"
# echo "    -i : ICA-FIX QC (you need to run PostFIX using ICA_Classification_SingleScreenTemplate_BMB.scene before running this script)"
 echo "    -f : Functional QC (you need to run RestingStateStats)"
 echo "    -d : Diffusion QC"
# echo "    -z <modality label>: zip archive for modality label (e.g. sfFdt). Output is <Study Folder>/<Subject ID>/QC/<Subject ID>_<modality label>.zip"
 echo ""
 echo " Optional arguments:"
 echo "    -a <num> : atlas species (0: Human [default], 1: Macaque [MacaqueRIKEN32BS], 1.1: Macaque cynomolgus [Mac24cyno], 1.2: rhesus (Mac25Rhesus), 2: Marmoset)"
# echo "    -m       : create movie of fMRI before and after ICA-FIX clean in Functional QC"
 echo ""
 exit 1
 
}

[[ $# -ge 3 ]] || Usage_exit

round () {
digit=$2
LANG=C printf "%1.${digit}f" $1
}

gifmergeh () {
# merge two gif files into a single gif horizontally
# assuming two gif files are same in frame size and rate
gif1=$1
gif2=$2
gifout=$3
tmp=gifmerge_$$
convert $gif1 -coalesce /tmp/${tmp}_a-%04d.gif  
convert $gif2 -coalesce /tmp/${tmp}_b-%04d.gif  
fr=$(identify -format "%f[%s] %T\n" $gif1 | awk 'NR==1 {print $2}')
for f in /tmp/${tmp}_a-*.gif; do convert $f ${f/a/b} +append ${f/a/c}; done
convert -loop 0 -delay $fr /tmp/${tmp}_c-*.gif $gifout
rm -rf /tmp/${tmp}_*
}

acpcnii2gif () {
Inp=$1
tmp=/tmp/ACPC2SliceGIF_$$
if [[ $2 = "-m" ]] ; then
	shift; 
	Brainmask=$2
	range="-i $(fslstats $Inp -k $Brainmask -P 4 -P 96)"
elif [[ $($FSLDIR/bin/imtest $2) = 1 ]] ; then
	range=$2
elif [[ $2 =~ NONE ]] ; then
	range=""
fi
Out=$3

i=30; while [ $i -le 214 ] ; do j=$(zeropad $i 3); slicer $Inp $range -z -$i ${tmp}_${j}.png; i=$((i + 8)); done
# 3 row x 8 column
#pngappend ${tmp}_030.png + ${tmp}_038.png + ${tmp}_046.png + ${tmp}_054.png + ${tmp}_062.png + ${tmp}_070.png + ${tmp}_078.png + ${tmp}_086.png  - ${tmp}_094.png + ${tmp}_102.png + ${tmp}_110.png + ${tmp}_118.png + ${tmp}_126.png + ${tmp}_134.png + ${tmp}_142.png + ${tmp}_150.png - ${tmp}_158.png + ${tmp}_166.png + ${tmp}_174.png + ${tmp}_182.png + ${tmp}_190.png + ${tmp}_198.png + ${tmp}_206.png + ${tmp}_214.png ${tmp}_out.png
# 4 row x 6 column - requested from Shinsuke Koike 
pngappend ${tmp}_030.png + ${tmp}_038.png + ${tmp}_046.png + ${tmp}_054.png + ${tmp}_062.png + ${tmp}_070.png - ${tmp}_078.png + ${tmp}_086.png + ${tmp}_094.png + ${tmp}_102.png + ${tmp}_110.png + ${tmp}_118.png - ${tmp}_126.png + ${tmp}_134.png + ${tmp}_142.png + ${tmp}_150.png + ${tmp}_158.png + ${tmp}_166.png - ${tmp}_174.png + ${tmp}_182.png + ${tmp}_190.png + ${tmp}_198.png + ${tmp}_206.png + ${tmp}_214.png ${tmp}_out.png
convert ${tmp}_out.png $Out
rm ${tmp}_???.png
}

tsv2html () {
#convert a TSV file to an HTML file
#author: Donald L. Merand

#note: this is most useful in conjunction with bcat, which sends results to the browser
# you can get bcat on OS X using homebrew
# http://mxcl.github.com/homebrew/
# then type "brew install bcat"

#also note: this script only creates an HTML snippet - you'll probably want to wrap
# it in some pretty CSS, not to mention <html> and <body> tags

#convert Mac line endings, if any
perl -p -e 's/\r/\n/g' |

#now do the conversion
awk '
BEGIN {
  FS="\t"
  printf "<table>\n"
}
{
  printf "\n\n<tr>"
  for (i=1;i<=NF;i++) {
    printf "<td>%s</td>", $i
  }
  printf "</tr>"
}
END {
  printf "\n</table>"
}'

}

logMsg () {
echo "$(date -R): $@"
}

[ "$3" = "" ] && Usage_exit
commands="$@"
StudyFolder=$1
Subject=$2
shift 2

WIDTH=1900
Species=0;
CreateMovie="OFF"
Struc="OFF"
ICAFIX="OFF"
Func="OFF"
Diff="OFF"
Zip="OFF"

while getopts sfdtFz:a:im OPT ; do
	case "$OPT" in
		"s" ) Struc="ON";;
		"f" ) Func="ON";;
		"d" ) Diff="ON";;
		"z" ) Zip="ON";Mod="$OPTARG";;
		"a" ) Species="$OPTARG";;
		"i" ) ICAFIX=ON;;
		"m" ) CreateMovie="ON";;
		* )  Usage_exit;;
    	esac
done;

if [ $Species = 0 ] ; then

	TemplateFolder=${BCILDIR}/data/HCP-S1200
	TemplateName=S1200
	LABEL=${TemplateFolder}/MNINonLinear/fsaverage_LR32k/Q1-Q6_RelatedParcellation210.CorticalAreas_dil_Final_Final_Areas_Group_Colors.32k_fs_LR.dlabel.nii
	MyelinQ1to3=${TemplateFolder}/MNINonLinear/S1200.MyelinMap_BC_MSMAll_Q1-2-3.164k_fs_LR.dscalar.nii
	ThicknessQ1to3=${TemplateFolder}/MNINonLinear/S1200.thickness_MSMAll_Q1-2-3.164k_fs_LR.dscalar.nii
	GreyordinateResolution=2
	ICAdim=40
	SPECIES=Human

elif [ $Species = 1 ] ; then

	TemplateFolder=${BCILDIR}/data/MacaqueRIKEN32BS
	TempateName=MacaqueRIKEN32BS
	MyelinQ1to3=${TemplateFolder}/MNINonLinear/${TempateName}.MyelinMap_BC_Q1-2-3.164k_fs_LR.dscalar.nii
	ThicknessQ1to3=${TemplateFolder}/MNINonLinear/${TempateName}.thickness_Q1-2-3.164k_fs_LR.dscalar.nii
	GreyordinateResolution=1.25
	ICAdim=19
	SPECIES=Macaque

elif [ $Species = 2 ] ; then

	TemplateFolder=${BCILDIR}/data/MarmosetRIKEN20
	TempateName=MarmosetRIKEN20
	MyelinQ1to3=${TemplateFolder}/MNINonLinear/${TempateName}.MyelinMap_BC_Q1-2-3.164k_fs_LR.dscalar.nii
	ThicknessQ1to3=${TemplateFolder}/MNINonLinear/${TempateName}.thickness_Q1-2-3.164k_fs_LR.dscalar.nii
	GreyordinateResolution=0.8
	ICAdim=10
	SPECIES=Marmoset
	
elif [ $Species = 1.1 ] ; then

	TemplateFolder=${BCILDIR}/data/SpecMac24cyno
	TempateName=SpecMac24cyno
	MyelinQ1to3=${TemplateFolder}/MNINonLinear/${TempateName}.MyelinMap_BC_Q1-2-3.164k_fs_LR.dscalar.nii
	ThicknessQ1to3=${TemplateFolder}/MNINonLinear/${TempateName}.thickness_Q1-2-3.164k_fs_LR.dscalar.nii
	GreyordinateResolution=1.25
	ICAdim=19
	SPECIES=MacaqueCyno

else
	echo "ERROR: unknown species: $Species"
	exit 1;
fi

if [ ! -w $StudyFolder/$Subject/ ] ; then
	echo "ERROR: do not have write permission or cannot find $StudyFolder/$Subject"
	exit 1;
fi

OutputFolder=$StudyFolder/$Subject/QC

mkdir -p $OutputFolder/.files

cp ${FSLDIR}/doc/fsl.css ${BCILDIR}/doc/images/BCIL_1.png ${BCILDIR}/doc/images/fsl-logo-x2.png ${BCILDIR}/doc/images/hcplogo1.jpg ${BCILDIR}/doc/images/freesurfer.png ${BCILDIR}/doc/images/bmb.png ${BCILDIR}/doc/images/favicon.ico ${BCILDIR}/doc/hcppipe_qc/magnifier.css ${BCILDIR}/doc/hcppipe_qc/magnifier.js ${BCILDIR}/doc/hcppipe_qc/jquery.min.js ${BCILDIR}/doc/hcppipe_qc/lightbox.css ${BCILDIR}/doc/hcppipe_qc/lightbox.min.js $OutputFolder/.files/

logMsg "Start hcppipe_qc"
logMsg "Command: $0 $commands"
logMsg "StudyFolder: $StudyFolder"
logMsg "Subject: $Subject"
logMsg "Host: `hostname`"
logMsg "Structure: $Struc"
logMsg "Function: $Func"
logMsg "Diffusion: $Diff"
logMsg "Zip: $Zip"

if [ -e $StudyFolder/$Subject/RawData/hcppipe_conf.txt ] ; then
	logMsg "Importing inputs data from $StudyFolder/$Subject/RawData/hcppipe_conf.txt" 
	source $StudyFolder/$Subject/RawData/hcppipe_conf.txt
	if [[ -z ${T1wInputImages+x} && -n $T1wlist ]] ; then
		T1wInputImages=$T1wlist
	fi
	if [[ -z ${T1wInputImages+x} && -n $T2wlist ]] ; then
		T2wInputImages=$T2wlist
	fi
	
fi

############################################################
# QC for Structure
############################################################

StrucQC () {

if [[ $Struc = ON && $(ls $StudyFolder/$Subject/MNINonLinear/*spec 2> /dev/null) = "" ]] ; then
 	echo "WARNING: not found spec files.. skip QC for structure" 
 	return

elif [[ $Struc = ON && ! $(ls $StudyFolder/$Subject/MNINonLinear/*spec 2> /dev/null) = "" ]] ; then

	logMsg "Creating Structural QC: $Subject"

	if [ -e $OutputFolder/Structure ] ; then rm -rf $OutputFolder/Structure; fi
	WD=$OutputFolder/Structure
	reportdir=${WD}/report
	reporthtml=${WD}/report.html
	mkdir -p $reportdir	
	touch $reporthtml

	echo "<HTML><HEAD><link REL=\"stylesheet\" TYPE=\"text/css\" href=\"../.files/fsl.css\"><TITLE>HCPPIPE QC REPORT</TITLE><link rel="icon" type="image/x-icon" href="../.files/favicon.ico"> <link href="../.files/lightbox.css" rel=stylesheet>
 <script src="../.files/jquery.min.js"></script><script src="../.files/lightbox.min.js" type="text/javascript"></script><link type="text/css" href="../.files/magnifier.css" rel="stylesheet"><script type="text/javascript" src="../.files/magnifier.js"></script></HEAD><BODY BGCOLOR=\"#FFFFFF\" TEXT=\"#151515\">" >> $reporthtml

	echo "<a name=\"Inputs\"><div id=\"Inputs\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Structure</span></B> - | <B>Inputs</B> | <a href=\"#Images\">Images</a> | <a href=\"#Fieldmap\">Fieldmap</a> | <a href=\"#Biasfield\">Biasfield</a> | <a href=\"#Registration\">Registration</a> | <a href=\"#Surfaces\">Surfaces</a><BR><BR>" >> $reporthtml

	if [[ -z ${TopupDwellTime+x} && -n $DwellTime ]] ; then 
		TopupDwellTime="$DwellTime"
	fi

	if [ ! -z "$T1wInputImages" ] ; then # imported imputs data from hcppipe_conf.txt
		echo "<I>Inputs to preprocessing</I><BR>" >> $reporthtml
		echo -e "Modality\tFilename\tSampleSpacing\tReadDir\tGradientCoil" > $reportdir/inputs_sMRI.tsv
		echo -e "T1w\t${T1wInputImages}\t${T1wSampleSpacing:-NONE}\t${ReadEncodinglist:-NONE}\t${Gradient:-NONE}" >> $reportdir/inputs_sMRI.tsv
		echo -e "T2w\t${T2wInputImages}\t${T2wSampleSpacing:-NONE}\t${ReadEncodinglist:-NONE}\t${Gradient:-NONE}" >> $reportdir/inputs_sMRI.tsv
		cat $reportdir/inputs_sMRI.tsv | tsv2html >> $reporthtml
		echo "<BR>" >> $reporthtml
		if [ ! -z "$TopupNegative" ] ; then 
			echo -e "Modality\tFilename\tPhaseEchoSpacing\tPhaseEncodingDir\tGradientCoil" > $reportdir/inputs_topup.tsv
			echo -e "TopupPositive\t$(echo $TopupPositive | awk '{print $1}')\t${TopupDwellTime}\tPositive\t${Gradient}" >> $reportdir/inputs_topup.tsv	
			echo -e "TopupNegative\t$(echo $TopupNegative | awk '{print $1}')\t${TopupDwellTime}\tNegative\t${Gradient}" >> $reportdir/inputs_topup.tsv	
			cat $reportdir/inputs_topup.tsv | tsv2html >> $reporthtml			
		fi
		echo "<BR>" >> $reporthtml
	fi

	if [ -e $StudyFolder/$Subject/RawData/Seriesinfo.csv ] ; then
		echo "<I>Scanning parameters for input volumes</I><BR>" >> $reporthtml
		echo -e "Filename\tSeriesNum\tProtocol\tTR[ms]\tTE[ms]\tTI[ms]\tFA[deg]\tMatrix\tPixelSize[mm]\tSliceThickness[mm]\tPreScanNorm\tDwelltimeRead[sec]\tDwelltimePhase[sec]\tReadDir\tPhaseDir\tSliceDir\tTxAmp[V]\tParallelFactor\tMultiBandFactor" > $reportdir/scaninfo.tsv
		for i in $T1wInputImages $T2wInputImages $(echo $TopupPositive | awk '{print $1}') $(echo $TopupNegative | awk '{print $1}') ; do
			if [ ! -z "$(ls -loh --time-style=iso $(imglob -extension $StudyFolder/$Subject/RawData/$i) | awk '{print $9}')" ] ; then
				scannum=$(echo $(basename $(ls -loh --time-style=iso $(imglob -extension $StudyFolder/$Subject/RawData/$i) | awk '{print $9}') | cut -d '_' -f 1))
				if [[ ! -z $(cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {print $15}' | grep NORM) ]] ; then
					PreScanNorm=ON
				else
					PreScanNorm=OFF
				fi
				pixsize=($(printf "%0.2f " $(cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {print $12}')))
				pixsize="${pixsize[0]}x${pixsize[1]}"
				cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {printf "%s\t%d\t%s\t%0.0f\t%0.2f\t%0.0f\t%d\t%s\t%s\t%0.2f\t%s\t%0.7f\t%0.7f\t%s\t%s\t%s\t%0.1f\t%d\t%d\n","'$i'",$1,$4,$7,$8,$9,$10,$11,"'${pixsize}'",$13,"'$PreScanNorm'",$16,$17,$18,$19,$20,$22,$23,$24}' >> $reportdir/scaninfo.tsv
			else
				echo -e "$i\tNo link to\tprotocol.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t" >> $reportdir/scaninfo.tsv
			fi
		done
		cat $reportdir/scaninfo.tsv | tsv2html >> $reporthtml
		echo "<BR>" >> $reporthtml
	fi

	# Images and stats

	echo "<a name=\"Images\"><div id=\"Images\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Structure</span></B> - | <a href=\"#Inputs\">Inputs<a> | <B>Images</B> | <a href=\"#Fieldmap\">Fieldmap</a> | <a href=\"#Biasfield\">Biasfield</a> | <a href=\"#Registration\">Registration</a> | <a href=\"#Surfaces\">Surfaces</a><BR><BR>" >> $reporthtml

	T1wFolder=$StudyFolder/$Subject/T1w 
	FreeSurferFolder=$T1wFolder/$Subject
	T1wImage=T1w_acpc_dc
	AtlasSpaceFolder=$StudyFolder/$Subject/MNINonLinear
	AtlasSpaceT1wImage=T1w_restore
	AtlasTransform=$AtlasSpaceFolder/xfms/acpc_dc2standard
	FreeSurferLabels=$HCPPIPEDIR/global/config/FreeSurferAllLut.txt

	if [ -e $FreeSurferFolder/mri/aseg.hires.mgz ] ; then 
		ASEG="${FreeSurferFolder}/mri/aseg.hires.mgz"
	else
		ASEG="${FreeSurferFolder}/mri/aseg.mgz"
	fi

	logMsg "Creating ROIs from aseg"
		 
	${FREESURFER_HOME}/bin/mri_convert -rt nearest -rl "$T1wFolder"/"$T1wImage".nii.gz $ASEG "$T1wFolder"/aseg_1mm.nii.gz >/dev/null
	${FSLDIR}/bin/applywarp --rel --interp=nn -i "$T1wFolder"/aseg_1mm.nii.gz -r "$AtlasSpaceFolder"/"$AtlasSpaceT1wImage" --premat=$FSLDIR/etc/flirtsch/ident.mat -o "$T1wFolder"/aseg.nii.gz
	${FSLDIR}/bin/applywarp --rel --interp=nn -i "$T1wFolder"/aseg_1mm.nii.gz -r "$AtlasSpaceFolder"/"$AtlasSpaceT1wImage" -w "$AtlasTransform" -o "$AtlasSpaceFolder"/aseg.nii.gz
	${CARET7DIR}/wb_command -volume-label-import "$T1wFolder"/aseg.nii.gz "$FreeSurferLabels" "$T1wFolder"/aseg.nii.gz -drop-unused-labels
	${CARET7DIR}/wb_command -volume-label-import "$AtlasSpaceFolder"/aseg.nii.gz "$FreeSurferLabels" "$AtlasSpaceFolder"/aseg.nii.gz -drop-unused-labels
	${CARET7DIR}/wb_command -volume-all-labels-to-rois "$T1wFolder"/aseg.nii.gz 1 "$T1wFolder"/aseg_rois.nii.gz

	TAB="$(printf '\\\011')"
	LF=$(printf '\\\012_')
	LF=${LF%_}

	for Image in T1w_acpc_dc T2w_acpc_dc T1wDividedByT2w T1w_acpc_dc_restore T2w_acpc_dc_restore; do
		if [ -e "$T1wFolder"/"$Image".nii.gz ] ; then
			logMsg "Creating gif for $Image"
			if [ $Image = T1wDividedByT2w ] ; then
				${FSLDIR}/bin/fslmaths "$T1wFolder"/"$Image".nii.gz -mas "$T1wFolder"/brainmask_fs.nii.gz "$T1wFolder"/"$Image"_brain.nii.gz
				${FSLDIR}/bin/fslmaths "$T1wFolder"/"$Image"_brain.nii.gz -uthr 100 -thr 100 -bin "$T1wFolder"/"$Image"_brain_100.nii.gz
				${FSLDIR}/bin/overlay 1 0 "$T1wFolder"/"$Image"_brain.nii.gz -a "$T1wFolder"/"$Image"_brain_100.nii.gz .1 1  "$T1wFolder"/"$Image"_brain_overlay.nii.gz
				acpcnii2gif "$T1wFolder"/"$Image"_brain_overlay.nii.gz NONE $OutputFolder/Structure/report/"${Image}".gif
				${FSLDIR}/bin/imrm "$T1wFolder"/"$Image"_brain_overlay.nii.gz
			else
				acpcnii2gif "$T1wFolder"/"$Image".nii.gz -m "$T1wFolder"/brainmask_fs.nii.gz $OutputFolder/Structure/report/"${Image}".gif
			fi
			echo "<I>${Image}</I><BR>"  >> $reporthtml
			if [[ ! $Image =~ restore ]] ; then 			
				if [ $Image != T1wDividedByT2w ] ; then
					echo "The image was registrated to ACPC space and corrected for static magnetic field (B0) distortion. Please check imaging artifacts and biological changes in the brain. If imaging artifacts are likely seen, please also check the raw image by clicking link below. <BR>" >> $reporthtml
				else
					echo "The image was calcurated for the voxesl in the brain dividing T1w by T2w in ACPC space. Please check imaging artifacts and biological changes in the brain. The voxels with divided-by-zero error are shown in yellow and should not be seen in the cerebral cortical ribbon. The number of those voxels in the cortical ribbon are counted and shown below. <BR>" >> $reporthtml
				fi
				size=($(identify -format '%w %h' $OutputFolder/Structure/report/${Image}.gif))
				rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
				dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
				echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${Image}.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
				if [ $Image = T1wDividedByT2w ] ; then
					${FSLDIR}/bin/fslmaths "$T1wFolder"/ribbon -thr 3 -uthr 3 -bin -mul 39 -add "$T1wFolder"/ribbon -thr 42 -uthr 42 -bin "$T1wFolder"/ribbon_bin
					infnvox=$(${FSLDIR}/bin/fslstats "$T1wFolder"/"$Image"_brain_100.nii.gz -k "$T1wFolder"/ribbon_bin.nii.gz -V | awk '{print $1}')
					echo "Number of divided-by-zero voxels in cerebral cortex: $infnvox <BR>"  >> $reporthtml
					${FSLDIR}/bin/imrm "$T1wFolder"/"$Image"_brain_100.nii.gz 
				fi
				if [[ $Image =~ acpc_dc ]] ; then # T1w or T2w
					RawImage=$(echo $Image | sed -e 's/_acpc_dc//g')		
					if [ -e $StudyFolder/$Subject/"$RawImage"/"$RawImage".nii.gz ] ; then
						range=$(fslstats $StudyFolder/$Subject/"$RawImage"/"$RawImage".nii.gz -P 4 -P 96)					
						${FSLDIR}/bin/slicer $StudyFolder/$Subject/"$RawImage"/"$RawImage".nii.gz -i $range -S 7 1900 $StudyFolder/$Subject/QC/Structure/report/${RawImage}.png
						convert $OutputFolder/Structure/report/${RawImage}.png $OutputFolder/Structure/report/${RawImage}.gif
						rm $OutputFolder/Structure/report/${RawImage}.png
						echo "<a href=\"./report/${RawImage}.gif\" target=\"_blank\">Raw image (open in a new tab)</a><BR>" >> $reporthtml	
					fi
				fi
			else
				echo "The restore image is corrected for radiofrequency (B1) bias estimated by sqrt(T1w * T2w) method (Glasser et al., 2011). Please find imaging homogeneity is increased in restore image comapred with non-restore image. <BR>" >> $reporthtml			
				size=($(identify -format '%w %h' $OutputFolder/Structure/report/${Image}.gif))
		 		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
				dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
				echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${Image}.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
			fi

			if [[ ! $Image =~ restore ]] ; then 
				logMsg "Stats for $Image"
				echo "brainmask_fs_MEAN" > $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean_col1.txt			
				${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce MEAN -roi "$T1wFolder"/brainmask_fs.nii.gz | sed "s/${TAB}/${LF}/g" > $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean_col2.txt
				echo "brainmask_fs_VARIANCE" > $StudyFolder/$Subject/QC/Structure/brainmask_fs_var_col1.txt
				${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce VARIANCE -roi "$T1wFolder"/brainmask_fs.nii.gz > $StudyFolder/$Subject/QC/Structure/brainmask_fs_var_col2.txt
				paste $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean_col?.txt > $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean.txt
				paste $StudyFolder/$Subject/QC/Structure/brainmask_fs_var_col?.txt > $StudyFolder/$Subject/QC/Structure/brainmask_fs_var.txt		
				
				${CARET7DIR}/wb_command -file-information "$T1wFolder"/aseg_rois.nii.gz -only-map-names | awk '{printf "%s_MEAN\n",$1}' > $StudyFolder/$Subject/QC/Structure/aseg_mean_col1.txt
				${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce MEAN -roi "$T1wFolder"/aseg_rois.nii.gz | sed "s/${TAB}/${LF}/g" > $StudyFolder/$Subject/QC/Structure/aseg_mean_col2.txt
				${CARET7DIR}/wb_command -file-information "$T1wFolder"/aseg_rois.nii.gz -only-map-names | awk '{printf "%s_VARIANCE\n",$1}' > $StudyFolder/$Subject/QC/Structure/aseg_var_col1.txt 
				${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce VARIANCE -roi "$T1wFolder"/aseg_rois.nii.gz | sed "s/${TAB}/${LF}/g" > $StudyFolder/$Subject/QC/Structure/aseg_var_col2.txt
				paste $StudyFolder/$Subject/QC/Structure/aseg_mean_col?.txt > $StudyFolder/$Subject/QC/Structure/aseg_mean.txt
				paste $StudyFolder/$Subject/QC/Structure/aseg_var_col?.txt > $StudyFolder/$Subject/QC/Structure/aseg_var.txt		
				cat $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean.txt $StudyFolder/$Subject/QC/Structure/aseg_mean.txt $StudyFolder/$Subject/QC/Structure/brainmask_fs_var.txt $StudyFolder/$Subject/QC/Structure/aseg_var.txt > $StudyFolder/$Subject/QC/Structure/${Image}_stats.txt
				rm $StudyFolder/$Subject/QC/Structure/aseg_*.txt $StudyFolder/$Subject/QC/Structure/brainmask_fs_*.txt 
				echo "<a href=\"./${Image}_stats.txt\" target=\"_blank\">Image signal stats (open in a new tab)</a><BR><BR>" >> $reporthtml
				cp $StudyFolder/$Subject/QC/Structure/${Image}_stats.txt $StudyFolder/$Subject/QC/Structure/${Image}_stats.tsv # Note that firefox does not open tsv file in tab
			else
				echo "<BR><BR>" >> $reporthtml
			fi
			
		fi
	done
	
	# Fieldmap
	if [[ -e $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/FieldMap ]] ; then

		echo "<a name=\"Fieldmap\"><div id=\"Fieldmap\"></div></a>" >> $reporthtml
		echo "<hr><B><span style=\"color:gray\">Structure</span></B> - | <a href=\"#Inputs\">Inputs<a> | <a href=\"#Images\">Images</a> | <B>Fieldmap</B> | <a href=\"#Biasfield\">Biasfield</a> | <a href=\"#Registration\">Registration</a> | <a href=\"#Surfaces\">Surfaces</a><BR><BR>" >> $reporthtml
		echo "Check that the input data of fieldmap is correctly used and properly analyzed -  SE filedmap should use a pair in inputs of the opposed phased encoding data (i.e. distorted symmetrically along phase encoding direction) and reasonably corrected for image-distortion and modulated by Jacobian.<BR>"  >> $reporthtml
 		T2wToT1wDir=$StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg
		FieldMapDir=$T2wToT1wDir/FieldMap
 		
		if [ -e ${FieldMapDir}/acqparams.txt ] ; then # SE fieldmap
			FMtype="SE field"
			if [[ $(cat ${FieldMapDir}/acqparams.txt | awk '{x = $1; S += x*x; N++;} END {print sqrt(S/N)}') != 0 ]] ; then
				PhaseDir=x
			elif [[ $(cat ${FieldMapDir}/acqparams.txt | awk '{x = $2; S += x*x; N++;} END {print sqrt(S/N)}') != 0 ]] ; then
				PhaseDir=y
			else
				PhaseDir=Unknown
			fi
			echo "Fieldmap type: $FMtype<BR>Opposing phase encoding axis: <B>$PhaseDir </B><BR><BR>" >> $reporthtml
			# Magnitude PhaseOne vs PhaseTwo to check registration & distortion correction quality
			for dc in _gdc _gdc_dc_jac ; do 
				${FSLDIR}/bin/fslroi ${FieldMapDir}/PhaseOne${dc}.nii.gz ${WD}/PhaseOne${dc}_vol0.nii.gz 0 1
				${FSLDIR}/bin/fslroi ${FieldMapDir}/PhaseTwo${dc}.nii.gz ${WD}/PhaseTwo${dc}_vol0.nii.gz 0 1
				${FSLDIR}/bin/flirt -in ${WD}/PhaseOne${dc}_vol0.nii.gz -ref ${FieldMapDir}/../T1w_acpc.nii.gz -applyxfm -init ${FieldMapDir}/../Fieldmap2T1w_acpc.mat -o ${WD}/PhaseOne${dc}_hires.nii.gz 
				${FSLDIR}/bin/flirt -in ${WD}/PhaseTwo${dc}_vol0.nii.gz -ref ${FieldMapDir}/../T1w_acpc.nii.gz -applyxfm -init ${FieldMapDir}/../Fieldmap2T1w_acpc.mat -o ${WD}/PhaseTwo${dc}_hires.nii.gz 
				${FSLDIR}/bin/slicer ${WD}/PhaseOne${dc}_hires.nii.gz ${FieldMapDir}/../T1w_acpc.nii.gz -s 2 -e .05 -a ${WD}/PhaseOne${dc}_hires.png
				${FSLDIR}/bin/slicer ${WD}/PhaseTwo${dc}_hires.nii.gz ${FieldMapDir}/../T1w_acpc.nii.gz -s 2 -e .05 -a ${WD}/PhaseTwo${dc}_hires.png

				convert -loop 0 -delay 100 ${WD}/PhaseOne${dc}_hires.png ${WD}/PhaseTwo${dc}_hires.png ${reportdir}/PhaseOnevsTwo${dc}.gif
				rm ${WD}/PhaseOne${dc}_hires.png ${WD}/PhaseTwo${dc}_hires.png
				imrm ${WD}/PhaseOne${dc}_vol0.nii.gz ${WD}/PhaseTwo${dc}_vol0.nii.gz ${WD}/PhaseOne${dc}_hires.nii.gz ${WD}/PhaseTwo${dc}_hires.nii.gz
				if [ $dc = _gdc_dc_jac ] ; then
					fslmaths ${FieldMapDir}/PhaseOne${dc}.nii.gz -sub ${FieldMapDir}/PhaseTwo${dc}.nii.gz -abs ${WD}/PhaseDiffAbs.nii.gz
				fi
				#echo "<IMG src=\"./report/PhaseOnevsTwo${dc}.gif\"  width=\"${WIDTH}\" border=\"0\"><BR><BR>" >> $reporthtml
			done
			echo "<I>Distorted (left) and distortion-corrected images of SE fieldmap data (right) </I><BR>"  >> $reporthtml
			gifmergeh ${reportdir}/PhaseOnevsTwo_gdc.gif ${reportdir}/PhaseOnevsTwo_gdc_dc_jac.gif ${reportdir}/PhaseOnevsTwo_gdc_merge.gif
			rm ${reportdir}/PhaseOnevsTwo_gdc.gif ${reportdir}/PhaseOnevsTwo_gdc_dc_jac.gif 
			size=($(identify -format '%w %h' ${reportdir}/PhaseOnevsTwo_gdc_merge.gif))
			rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
			dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/PhaseOnevsTwo_gdc_merge.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

			# Fieldmap and agnitude vs T1w_acpc to check registration
			$FSLDIR/bin/fslmaths $T2wToT1wDir/FieldMap2T1w_acpc -thr 0 $T2wToT1wDir/FieldMap2T1w_acpc_p
			$FSLDIR/bin/fslmaths $T2wToT1wDir/FieldMap2T1w_acpc -uthr 0 -mul -1 $T2wToT1wDir/FieldMap2T1w_acpc_m			
			$FSLDIR/bin/overlay 1 0 $T2wToT1wDir/T1w_acpc.nii.gz -a $T2wToT1wDir/FieldMap2T1w_acpc_p  .1 500 $T2wToT1wDir/FieldMap2T1w_acpc_m .1 500 $T2wToT1wDir/FieldMap2T1w_acpc_overlay.nii.gz
			$FSLDIR/bin/slicer $T2wToT1wDir/FieldMap2T1w_acpc_overlay.nii.gz -s 2 -a ${reportdir}/FieldMap2T1w_acpc_overlay.png
			if [ -e ${FieldMapDir}/../Magnitude_brain_warppedT1w2T1w_acpc.nii.gz ] ; then #SE fieldmap
				Mag2T1w=${FieldMapDir}/../Magnitude_brain_warppedT1w2T1w_acpc.nii.gz
			elif [ -e ${FieldMapDir}/../Magnitude_warppedT1w2T1w_acpc.nii.gz ] ; then # GE filedmap
				Mag2T1w=${FieldMapDir}/../Magnitude_warppedT1w2T1w_acpc.nii.gz
			fi
			${FSLDIR}/bin/slicer $Mag2T1w ${FieldMapDir}/../T1w_acpc.nii.gz -s 2 -a ${reportdir}/MagT1w_acpc.png
			$FSLDIR/bin/pngappend ${reportdir}/FieldMap2T1w_acpc_overlay.png + ${reportdir}/MagT1w_acpc.png ${reportdir}/FieldMapMag2T1w_acpc_overlay.png
			rm ${reportdir}/FieldMap2T1w_acpc_overlay.png ${reportdir}/MagT1w_acpc.png
			
			echo "<I>B0 fieldmap and magnitude</I><BR>" >> $reporthtml
			echo "Check that fieldmap (red/blue color in left panel) is high in inferior frontal & temporal areas but not very high in other areas. The IQR of fieldmap is useally less than 200 rad/sec. Check that the magnitude is well reconstructed and aligned with T1w_acpc (red contour, right panel). <BR>" >> $reporthtml
			size=($(identify -format '%w %h' ${reportdir}/FieldMapMag2T1w_acpc_overlay.png))
			rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
			dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/FieldMapMag2T1w_acpc_overlay.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
			cp $FSLDIR/etc/luts/ramp*.gif ${reportdir}/
			echo "-500<img src=\"./report/ramp2.gif\"><img src=\"./report/ramp.gif\">500 <BR>" >> $reporthtml
			# Topup fieldmap
			echo -e "${FMtype} B0 fieldmap [rad/sec] in brain area\t" > ${WD}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/TopupField.nii.gz -k ${FieldMapDir}/Magnitude_brain -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ1\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> ${WD}/Fieldmap_stats.tsv
			${CARET7DIR}/wb_command -volume-gradient ${FieldMapDir}/TopupField.nii.gz  ${FieldMapDir}/TopupField_grad.nii.gz 
			echo -e "B0 fieldmap gradient in brain area\t" >> ${WD}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/TopupField_grad.nii.gz  -k ${FieldMapDir}/Magnitude_brain -m | awk '{printf "Gradient (mean)\t%1.2f\n",$1}' >> ${WD}/Fieldmap_stats.tsv
			echo -e "Phase diff abs in brain area\t" >> ${WD}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${WD}/PhaseDiffAbs.nii.gz -k ${FieldMapDir}/Magnitude_brain -m | awk '{printf "PhaseDiffAbs (mean)\t%1.2f\n",$1}' >> ${WD}/Fieldmap_stats.tsv

			cat ${WD}/Fieldmap_stats.tsv | tsv2html >> $reporthtml			
	 		echo -e "FSL_FLIRT_mincost\n$(flirt -in $Mag2T1w -ref ${FieldMapDir}/../T1w_acpc.nii.gz  -schedule ${FSLDIR}/etc/flirtsch/measurecost1.sch -init ${FieldMapDir}/../Fieldmap2T1w_acpc.mat | head -1 | awk '{print $1}')" > $WD/FieldmapMag2T1w.mincost.csv
			cat $WD/FieldmapMag2T1w.mincost.csv | awk -F, '{ for (i=1; i<=NF; i++)  { a[NR,i] = $i } } NF>p { p = NF }END {for(j=1; j<=p; j++) { str=a[1,j]; for(i=2; i<=NR; i++){ str=str"\t"a[i,j]; } printf "%s\n", str}}' > $WD/FieldmapMag2T1w.mincost.tsv

			rm $WD/FieldmapMag2T1w.mincost.csv
			# output tab delimited txt to html
			cat $WD/FieldmapMag2T1w.mincost.tsv | tsv2html >> $reporthtml			

		elif [ -e ${FieldMapDir}/FieldMap.nii.gz ] ; then  # GE fieldmap
			FMtype="GE field"			# GE fieldmap
			echo -e "${FMtype} B0 fieldmap [rad/sec] in brain area\t" > ${WD}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/FieldMap.nii.gz -k ${FieldMapDir}/Magnitude_brain -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ1\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> ${WD}/Fieldmap_stats.tsv
			${CARET7DIR}/wb_command -volume-gradient ${FieldMapDir}/FieldMap.nii.gz ${FieldMapDir}/FieldMap_gradient.nii.gz
			echo -e "B0 fieldmap gradient in brain area\t" >> ${WD}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/FieldMap_gradient.nii.gz -k ${FieldMapDir}/Magnitude_brain -m | awk '{printf "Gradient (mean)\t%1.2f\n",$1}' >> ${WD}/Fieldmap_stats.tsv

			cat ${WD}/Fieldmap_stats.tsv | tsv2html >> $reporthtml			
	 		echo -e "FSL_FLIRT_mincost\n$(flirt -in $Mag2T1w -ref ${FieldMapDir}/../T1w_acpc.nii.gz  -schedule ${FSLDIR}/etc/flirtsch/measurecost1.sch -init ${FieldMapDir}/../Fieldmap2T1w_acpc.mat | head -1 | awk '{print $1}')" > $WD/FieldmapMag2T1w.mincost.csv
			cat $WD/FieldmapMag2T1w.mincost.csv | awk -F, '{ for (i=1; i<=NF; i++)  { a[NR,i] = $i } } NF>p { p = NF }END {for(j=1; j<=p; j++) { str=a[1,j]; for(i=2; i<=NR; i++){ str=str"\t"a[i,j]; } printf "%s\n", str}}' > $WD/FieldmapMag2T1w.mincost.tsv

			rm $WD/FieldmapMag2T1w.mincost.csv
			# output tab delimited txt to html
			cat $WD/FieldmapMag2T1w.mincost.tsv | tsv2html >> $reporthtml

		else
			echo "<p style=\"color:red\"><B>Warning: cannot find fieldmap data.</B></p>" >> $reporthtml
		fi
	
	fi

	# T1wMulT2w Biasfield
	if [ -e $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT1w ] ; then
		logMsg "WARNING: HCP pipeline was analyzed with ver 3. T1w/BiasFieldCorrection_sqrtT1wXT1w will be symbolic linked to T1w/BiasFieldCorrection_sqrtT1wXT2w."
		ln -sf BiasFieldCorrection_sqrtT1wXT1w $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT2w
	fi

	if [ -e $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT2w ] ; then
		logMsg "Creating biasfild QC"
		echo "<a name=\"Biasfield\"><div id=\"Biasfield\"></div></a>" >> $reporthtml
		echo "<hr><B><span style=\"color:gray\">Structure</span></B> - | <a href=\"#Inputs\">Inputs<a> | <a href=\"#Images\">Images</a> | <a href=\"#Fieldmap\">Fieldmap</a> | <B>Biasfield</B> | <a href=\"#Registration\">Registration</a> | <a href=\"#Surfaces\">Surfaces</a><BR><BR>" >> $reporthtml

		if [ -e "$T1wFolder"/BiasFieldCorrection_sqrtT1wXT2w/T1wmulT2w.nii.gz ] ; then
			ln -sf BiasFieldCorrection_sqrtT1wXT2w/T1wmulT2w.nii.gz "$T1wFolder"/T1wmulT2w.nii.gz
		fi
		Image=T1wmulT2w 
		logMsg "Creating gif for $Image"
		acpcnii2gif "$T1wFolder"/"$Image".nii.gz -m "$T1wFolder"/brainmask_fs.nii.gz $OutputFolder/Structure/report/${Image}.gif		
		echo "<I>sqrtT1wMulT2w</I><BR>"  >> $reporthtml
		echo "This image is formed by sqrt(T1w*T2w) and is useful to find imaging artifacts including signal inhomogeneity bias and motioin. This image is used for estimating low-spatial frequency B1 biasfield in T1w and T2w images. <BR>" >> $reporthtml
		size=($(identify -format '%w %h' $OutputFolder/Structure/report/${Image}.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${Image}.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
		logMsg "Stats for $Image"
		echo "brainmask_fs_MEAN" > $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean_col1.txt			
		${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce MEAN -roi "$T1wFolder"/brainmask_fs.nii.gz | sed "s/${TAB}/${LF}/g" > $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean_col2.txt
		echo "brainmask_fs_VARIANCE" > $StudyFolder/$Subject/QC/Structure/brainmask_fs_var_col1.txt
		${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce VARIANCE -roi "$T1wFolder"/brainmask_fs.nii.gz > $StudyFolder/$Subject/QC/Structure/brainmask_fs_var_col2.txt
		paste $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean_col?.txt > $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean.txt
		paste $StudyFolder/$Subject/QC/Structure/brainmask_fs_var_col?.txt > $StudyFolder/$Subject/QC/Structure/brainmask_fs_var.txt		
				
		${CARET7DIR}/wb_command -file-information "$T1wFolder"/aseg_rois.nii.gz -only-map-names | awk '{printf "%s_MEAN\n",$1}' > $StudyFolder/$Subject/QC/Structure/aseg_mean_col1.txt
		${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce MEAN -roi "$T1wFolder"/aseg_rois.nii.gz | sed "s/${TAB}/${LF}/g" > $StudyFolder/$Subject/QC/Structure/aseg_mean_col2.txt
		${CARET7DIR}/wb_command -file-information "$T1wFolder"/aseg_rois.nii.gz -only-map-names | awk '{printf "%s_VARIANCE\n",$1}' > $StudyFolder/$Subject/QC/Structure/aseg_var_col1.txt 
		${CARET7DIR}/wb_command -volume-stats "$T1wFolder"/"$Image".nii.gz -reduce VARIANCE -roi "$T1wFolder"/aseg_rois.nii.gz | sed "s/${TAB}/${LF}/g" > $StudyFolder/$Subject/QC/Structure/aseg_var_col2.txt
		paste $StudyFolder/$Subject/QC/Structure/aseg_mean_col?.txt > $StudyFolder/$Subject/QC/Structure/aseg_mean.txt
		paste $StudyFolder/$Subject/QC/Structure/aseg_var_col?.txt > $StudyFolder/$Subject/QC/Structure/aseg_var.txt		
		cat $StudyFolder/$Subject/QC/Structure/brainmask_fs_mean.txt $StudyFolder/$Subject/QC/Structure/aseg_mean.txt $StudyFolder/$Subject/QC/Structure/brainmask_fs_var.txt $StudyFolder/$Subject/QC/Structure/aseg_var.txt > $StudyFolder/$Subject/QC/Structure/${Image}_stats.txt
		rm $StudyFolder/$Subject/QC/Structure/aseg_*.txt $StudyFolder/$Subject/QC/Structure/brainmask_fs_*.txt 
		echo "<a href=\"./${Image}_stats.txt\" target=\"_blank\">Image signal stats (open in a new tab)</a><BR><BR>" >> $reporthtml
		cp $StudyFolder/$Subject/QC/Structure/${Image}_stats.txt $StudyFolder/$Subject/QC/Structure/${Image}_stats.tsv # Note that firefox does not open tsv file in tab
		rm "$T1wFolder"/T1wmulT2w.nii.gz
		acpcnii2gif  $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT2w/T1wmulT2w_brain_norm.nii.gz $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT2w/T1wmulT2w_brain_norm_modulate_mask.nii.gz $OutputFolder/Structure/report/T1wmulT2w_brain_norm_modulate_mask.gif
		echo "<I>T1wmulT2w_brain_norm_mmodulate_mask</I><BR>"  >> $reporthtml
		echo "Please check red countors outline non-white matter structures (e.g. ventricles, vasculature, sulci) and reasonably small.<BR>"  >> $reporthtml
		size=($(identify -format '%w %h' $OutputFolder/Structure/report/T1wmulT2w_brain_norm_modulate_mask.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/T1wmulT2w_brain_norm_modulate_mask.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
		val=$(echo "scale=2; $(${FSLDIR}/bin/fslstats $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT2w/T1wmulT2w_brain_norm_modulate_mask.nii.gz -V | awk '{print $1}')/$(${FSLDIR}/bin/fslstats $StudyFolder/$Subject/T1w/BiasFieldCorrection_sqrtT1wXT2w/T1wmulT2w_brain.nii.gz -V | awk '{print $1}')" | bc -l)
		echo -e "T1wmulT2w_brain_norm_modulate_mask_ratio\t$val\n" > $OutputFolder/Structure/T1wmulT2w_brain_norm_modulate_stats.tsv
		cat $OutputFolder/Structure/T1wmulT2w_brain_norm_modulate_stats.tsv | tsv2html >> $reporthtml
		echo "<BR>"  >> $reporthtml
		
		${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/T1w/BiasField_acpc_dc.nii.gz -sub 1 -thr 0 $OutputFolder/Structure/report/BiasField_thr1
		${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/T1w/BiasField_acpc_dc.nii.gz -sub 1 -mul -1 -thr 0 $OutputFolder/Structure/report/BiasField_uthr1		
		${FSLDIR}/bin/overlay 1 0 $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore.nii.gz -a $OutputFolder/Structure/report/BiasField_thr1.nii.gz 0.001 0.2 $OutputFolder/Structure/report/BiasField_uthr1.nii.gz 0.001 0.2 $OutputFolder/Structure/report/BiasFieldOverlay.nii.gz
		acpcnii2gif $OutputFolder/Structure/report/BiasFieldOverlay.nii.gz NONE $OutputFolder/Structure/report/BiasFieldOverlay.gif
		${FSLDIR}/bin/imrm $OutputFolder/Structure/report/BiasFieldOverlay.nii.gz $OutputFolder/Structure/report/BiasField_thr1 $OutputFolder/Structure/report/BiasField_uthr1
		imrm $OutputFolder/Structure/report/BiasField_thr1 $OutputFolder/Structure/report/BiasField_uthr1 $OutputFolder/Structure/report/BiasFieldOverlay
		echo "<I>T1wMulT2w biasfield</I><BR>"  >> $reporthtml
		echo "Please check biasfield is concentric and minimal asymmetry over the brain<BR>"  >> $reporthtml
		size=($(identify -format '%w %h' $OutputFolder/Structure/report/BiasFieldOverlay.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/BiasFieldOverlay.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
		cp $FSLDIR/etc/luts/ramp*.gif ${reportdir}/
		echo "-0.8<img src=\"./report/ramp2.gif\"><img src=\"./report/ramp.gif\">1.2 <BR>" >> $reporthtml
		echo -e "T1wMulT2w Biasfield in brain area\t" > $OutputFolder/Structure/BiasField_acpc_dc_stats.tsv
		${FSLDIR}/bin/fslstats $StudyFolder/$Subject/T1w/BiasField_acpc_dc.nii.gz -k $StudyFolder/$Subject/T1w/T1w_acpc_dc_brain -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nQ4\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> $OutputFolder/Structure/BiasField_acpc_dc_stats.tsv
		cat $OutputFolder/Structure/BiasField_acpc_dc_stats.tsv | tsv2html >> $reporthtml
	fi
	
	# Create structural QC scenes
	DummyPath="DUMMYPATH" #This is an actual string in the TEMPLATE_structuralQC.scene file.

	mkdir -p $OutputFolder/Structure/Templates/fsaverage_LR32k

	# Copy templates
	if [ $Species = 0 ] ; then # Human
		cp ${TemplateFolder}/MNINonLinear/S1200.[L,R].inflated_MSMAll.164k_fs_LR.surf.gii ${TemplateFolder}/MNINonLinear/S1200.[L,R].midthickness_MSMAll.164k_fs_LR.surf.gii ${TemplateFolder}/MNINonLinear/S1200.MyelinMap_BC_MSMAll.164k_fs_LR.dscalar.nii ${TemplateFolder}/MNINonLinear/S1200.sulc_MSMAll.164k_fs_LR.dscalar.nii $OutputFolder/Structure/Templates/
		flirt -in ${TemplateFolder}/MNINonLinear/MNI152_T1_0.7mm.nii.gz -ref  $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore.nii.gz -applyxfm -init $FSLDIR/etc/flirtsch/ident.mat -o $OutputFolder/Structure/Templates/MNI152_T1_0.7mm.nii.gz -interp sinc
		cp ${TemplateFolder}/MNINonLinear/fsaverage_LR32k/S1200.MyelinMap_MSMAll.32k_fs_LR.dscalar.nii ${TemplateFolder}/MNINonLinear/fsaverage_LR32k/S1200.MyelinMap_BC_MSMAll.32k_fs_LR.dscalar.nii ${TemplateFolder}/MNINonLinear/fsaverage_LR32k/S1200.thickness_MSMAll.32k_fs_LR.dscalar.nii $OutputFolder/Structure/Templates/fsaverage_LR32k/
			
	else # MSMAll is not yet established in NHP
		cp ${TemplateFolder}/MNINonLinear/${TempateName}_AverageT1w_restore.nii.gz $OutputFolder/Structure/Templates/MNI152_T1_0.7mm.nii.gz
		for hemi in L R; do
			cp ${TemplateFolder}/MNINonLinear/${TempateName}.${hemi}.inflated.164k_fs_LR.surf.gii $OutputFolder/Structure/Templates/S1200.${hemi}.inflated_MSMAll.164k_fs_LR.surf.gii
			cp ${TemplateFolder}/MNINonLinear/${TempateName}.${hemi}.midthickness.164k_fs_LR.surf.gii $OutputFolder/Structure/Templates/S1200.${hemi}.midthickness_MSMAll.164k_fs_LR.surf.gii
		done
		cp ${TemplateFolder}/MNINonLinear/${TempateName}.MyelinMap_BC.164k_fs_LR.dscalar.nii $OutputFolder/Structure/Templates/S1200.MyelinMap_BC_MSMAll.164k_fs_LR.dscalar.nii
		cp ${TemplateFolder}/MNINonLinear/${TempateName}.sulc.164k_fs_LR.dscalar.nii $OutputFolder/Structure/Templates/S1200.sulc_MSMAll.164k_fs_LR.dscalar.nii
		cp ${TemplateFolder}/MNINonLinear/fsaverage_LR32k/${TempateName}.MyelinMap.32k_fs_LR.dscalar.nii  $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.MyelinMap_MSMAll.32k_fs_LR.dscalar.nii
		cp ${TemplateFolder}/MNINonLinear/fsaverage_LR32k/${TempateName}.MyelinMap_BC.32k_fs_LR.dscalar.nii  $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.MyelinMap_BC_MSMAll.32k_fs_LR.dscalar.nii
		cp ${TemplateFolder}/MNINonLinear/fsaverage_LR32k/${TempateName}.thickness.32k_fs_LR.dscalar.nii  $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.thickness_MSMAll.32k_fs_LR.dscalar.nii

	fi

	# Registration
	echo "<a name=\"Registration\"><div id=\"Registration\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Structure</span></B> - | <a href=\"#Inputs\">Inputs<a> | <a href=\"#Images\">Images</a> | <a href=\"#Fieldmap\">Fieldmap</a> | <a href=\"#Biasfield\">Biasfield</a> | <B>Registration</B> | <a href=\"#Surfaces\">Surfaces</a><BR><BR>" >> $reporthtml

	# QC for T2wMulT1w	
	if [ -e $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w2T1w ] ; then
		if [ -e $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w2T1w/sqrtT1wbyT2w.nii.gz ] ; then
			${FSLDIR}/bin/slicer $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w2T1w/sqrtT1wbyT2w.nii.gz -s 2 -a $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png
			#convert $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.gif
			#rm $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png
		fi
	elif [ -e  $StudyFolder/$Subject/T2w/T2wToT1wReg ] ; then
		${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -mul $StudyFolder/$Subject/T2w/T2wToT1wReg/T2w2T1w.nii.gz -sqrt $StudyFolder/$Subject/T2w/T2wToT1wReg/sqrtT1wbyT2w.nii.gz
		${FSLDIR}/bin/slicer $StudyFolder/$Subject/T2w/T2wToT1wReg/sqrtT1wbyT2w.nii.gz -s 2 -a $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png
		#convert $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.gif
	fi
	
	if [ -e $StudyFolder/$Subject/T1w/${Subject}_1mm ] ; then
		FSSubjecDir=${Subject}_1mm
	else
		FSSubjecDir=${Subject}
	fi

	if [[ -e $StudyFolder/$Subject/T1w/${FSSubjecDir}/mri/T1wMulT2w_hires.nii.gz ]] ; then 
		${FSLDIR}/bin/slicer $StudyFolder/$Subject/T1w/${FSSubjecDir}/mri/T1wMulT2w_hires.nii.gz -s 2 -a $OutputFolder/Structure/report/sqrtT1wbyT2w_FS.png
		#convert $OutputFolder/Structure/report/sqrtT1wbyT2w_FS.png $OutputFolder/Structure/report/sqrtT1wbyT2w_FS.gif
		pngappend $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png - $OutputFolder/Structure/report/sqrtT1wbyT2w_FS.png $OutputFolder/Structure/report/sqrtT1wbyT2w.png
		rm $OutputFolder/Structure/report/sqrtT1wbyT2w_FSL.png $OutputFolder/Structure/report/sqrtT1wbyT2w_FS.png
		convert $OutputFolder/Structure/report/sqrtT1wbyT2w.png $OutputFolder/Structure/report/sqrtT1wbyT2w.gif
		
		echo "<I>sqrtT1wMulT2w</I><BR>"  >> $reporthtml
		echo "Please check T1w and T2w images are well aligned together after FSL BBR and FreeSurferBBR. If the image of 'Square root of T1w multiplied by T2w' shows curved lines between Gm/WM boundaries, the T1w and T2w images may not be well alighed. Also please find the BBR cost is reasonably small. In most cases of successful registraion, the values of FS BBR cost may be less than 0.3. <BR><BR>" >> $reporthtml
		echo "Result of BBR (left, FSL-BBR, right, FreeSurfer-BBR)<BR>" >> $reporthtml
		size=($(identify -format '%w %h' $OutputFolder/Structure/report/sqrtT1wbyT2w.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/sqrtT1wbyT2w.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml

	else
		echo "<I>sqrtT1wMulT2w</I><BR>"  >> $reporthtml
		echo "Not found sqrtT1wMulT2w image <BR><BR>" >> $reporthtml
	fi

	if [ -e $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w2T1w ] ; then	
		echo -e "FSL_BBR_mincost\t$(flirt -in $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w_acpc.nii.gz -ref $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T1w_acpc.nii.gz -schedule $FSLDIR/etc/flirtsch/measurecost1.sch -init  $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w2T1w/T2w_reg.mat -wmseg  $StudyFolder/$Subject/T2w/T2wToT1wDistortionCorrectAndReg/T2w2T1w/T2w_reg_fast_wmseg.nii.gz -cost bbr | head -1 | awk '{print $1}')" > $OutputFolder/Structure/T2wToT1w.mincost.tsv
	elif [ -e  $StudyFolder/$Subject/T2w/T2wToT1wReg  ] ; then
		echo -e "FSL_BBR_mincost\t$(flirt -in $StudyFolder/$Subject/T2w/T2w_acpc.nii.gz -ref $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -schedule $FSLDIR/etc/flirtsch/measurecost1.sch -init  $StudyFolder/$Subject/T2w/T2wToT1wReg/T2w2T1w.mat -wmseg  $StudyFolder/$Subject/T2w/T2wToT1wReg/T2w2T1w_fast_wmseg.nii.gz -cost bbr | head -1 | awk '{print $1}')" > $OutputFolder/Structure/T2wToT1w.mincost.tsv
	fi
	if [ -e $StudyFolder/$Subject/T1w/${FSSubjecDir}/mri/transforms/T2wtoT1w.dat.mincost ] ; then
		echo -e "FreeSurfer_BBR_mincost\t$(cat $StudyFolder/$Subject/T1w/${FSSubjecDir}/mri/transforms/T2wtoT1w.dat.mincost | awk '{print $1}')" >> $OutputFolder/Structure/T2wToT1w.mincost.tsv
	elif [ -e $StudyFolder/$Subject/T1w/${FSSubjecDir}/mri/transforms/T2raw.auto.dat.mincost ] ; then
		echo -e "FreeSurfer_BBR_mincost\t$(cat $StudyFolder/$Subject/T1w/${FSSubjecDir}/mri/transforms/T2raw.auto.dat.mincost | awk '{print $1}')" >> $OutputFolder/Structure/T2wToT1w.mincost.tsv
	fi
	
	if [ -e $OutputFolder/Structure/T2wToT1w.mincost.tsv ] ; then	
		# output tab delimited txt to html
		cat $OutputFolder/Structure/T2wToT1w.mincost.tsv | tsv2html >> $reporthtml
	fi
	echo "<BR>" >> $reporthtml

	# Create T1w and MNI152 overlay
	logMsg "Creating T1w+MNI152"
	if [ $(imtest $StudyFolder/$Subject/MNINonLinear/T1wTemplate) = 1 ] ; then
		imcp $StudyFolder/$Subject/MNINonLinear/T1wTemplate $StudyFolder/$Subject/QC/Structure/Templates/MNI152_T1_0.7mm.nii.gz
	fi

	${FSLDIR}/bin/slicer $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore.nii.gz $StudyFolder/$Subject/QC/Structure/Templates/MNI152_T1_0.7mm.nii.gz -s 2 -e 0.05 -a $OutputFolder/Structure/report/T1w_acpc_dc_restore+MNI152.png
	${FSLDIR}/bin/slicer $StudyFolder/$Subject/MNINonLinear/T1w_restore.nii.gz $StudyFolder/$Subject/QC/Structure/Templates/MNI152_T1_0.7mm.nii.gz -s 2 -e 0.05 -a $OutputFolder/Structure/report/T1w_restore+MNI152.png
	echo "<I>T1w in MNI152 in MNI space (left, T1w_acpc_dc, right, T1w_restore) </I><BR>"  >> $reporthtml
	echo "Left) Please check subject's head+brain image (T1w_acpc_dc_restore) in gray color is appropriately positioned in AC-PC MNI space. Red coutours indicate MNI152 standard head+brain. Note that the size and shape of subject's head+brain can be different from MNI152 standard head+brain, because this image is transformed to this space without any scaling (or zooming), shearing or warping. Right) Please check subject's non-linear warped head+brain image (T1w_restore) in gray color is appropriately positioned and well warpred in AC-PC MNI space. Red coutours indicate MNI152 standard head+brain. Note that the size and shape of subject's head+brain is close to those of MNI152 standard head+brain, because this image is transformed to this space with linear and non-linear warping. <BR>" >> $reporthtml
	pngappend $OutputFolder/Structure/report/T1w_acpc_dc_restore+MNI152.png - $OutputFolder/Structure/report/T1w_restore+MNI152.png $OutputFolder/Structure/report/T1w+MNI152.png
	convert $OutputFolder/Structure/report/T1w+MNI152.png $OutputFolder/Structure/report/T1w+MNI152.gif
	rm $OutputFolder/Structure/report/T1w_acpc_dc_restore+MNI152.png $OutputFolder/Structure/report/T1w_restore+MNI152.png $OutputFolder/Structure/report/T1w+MNI152.png 
	size=($(identify -format '%w %h' $OutputFolder/Structure/report/T1w+MNI152.gif))
	rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
	dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
	echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/T1w+MNI152.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
	
	# Create Workbench Scene
	cat $TemplateFolder/scenes/TEMPLATE_structuralQC.scene | sed "s#SubjectID#$Subject#g" | sed "s#S1200.#Templates/S1200.#g" | sed "s#MNI152_T1_0.7mm.nii.gz#Templates/MNI152_T1_0.7mm.nii.gz#g" > $OutputFolder/Structure/StructuralQC.scene
	# NOTES: how to create TEMPLATE_structuralQC.scene
	# Subject=K1805171800_MR1
	# cat $Subject/QC/Structure/StructuralQC.scene | sed "s#$Subject#SubjectID#g" | sed "s#Templates/S1200.#S1200.#g" | sed "s#Templates/MNI152_T1_0.7mm.nii.gz#MNI152_T1_0.7mm.nii.gz#g"  > TEMPLATE_structuralQC.scene

	#CWD=`pwd`
	#cd $StudyFolder/$Subject/MNINonLinear
	#if [ ! -e ${Subject}.ArealDistortion_MSMAll.164k_fs_LR.dscalar.nii ] ; then
	#
	#	ln -sf ${Subject}.ArealDistortion_MSMAll_2_d${ICAdim}_WRN.164k_fs_LR.dscalar.nii ${Subject}.ArealDistortion_MSMAll.164k_fs_LR.dscalar.nii
	#fi
	#if [ ! -e ${Subject}.EdgeDistortion_MSMAll.164k_fs_LR.dscalar.nii ] ; then
	#	ln -sf ${Subject}.EdgeDistortion_MSMAll_2_d${ICAdim}_WRN.164k_fs_LR.dscalar.nii ${Subject}.EdgeDistortion_MSMAll.164k_fs_LR.dscalar.nii
	#fi
	#cd $CWD

	echo "<a name=\"Surfaces\"><div id=\"Surfaces\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Structure</span></B> - | <a href=\"#Inputs\">Inputs<a> | <a href=\"#Images\">Images</a> | <a href=\"#Fieldmap\">Fieldmap</a> | <a href=\"#Biasfield\">Biasfield</a> | <a href=\"#Registration\">Registration</a> | <B>Surfaces</B><BR><BR>" >> $reporthtml
	echo  "Please check pial and white surfaces (scene #1), MyelinMap_BC (subject's, group average), Sulc (subject's and group average) and Areal Distortion of surface registration (MSMSulc, MSMAll) (scnee #2), and Jacobian of non-linear volume registraion (scene #3). The following images can be closely viewed by running the following command:<BR>" >> $reporthtml
	echo "<div style=\"background: ghostwhite; font-size: 12px; padding: 12px;; border: 1px solid lightgray; margin: 1px;\"<p><code> $ wb_view $Subject/QC/Structure/StructuralQC.scene.</code></p></div><BR>"  >> $reporthtml

	i=1
	${CARET7DIR}/wb_command -show-scene $OutputFolder/Structure/StructuralQC.scene $i ${reportdir}/StructuralQC_${i}.png 1800 1200 > /dev/null 2>&1
	${CARET7DIR}/wb_command -file-information $OutputFolder/Structure/StructuralQC.scene | grep '#' | awk 'NR=='$i' {printf "<I>StructuralQC.scene: %s</I><BR>", $0}' >> $reporthtml
	echo "Pial and white surfaces are overlaid on T1w_restore in MNINonLinear space. Please check the surfaces are correcty estimated. <BR>">> $reporthtml
	convert ${reportdir}/StructuralQC_${i}.png -quality 85 ${reportdir}/StructuralQC_${i}.jpg
	rm -rf ${reportdir}/StructuralQC_${i}.png
	size=($(identify -format '%w %h' $OutputFolder/Structure/report/StructuralQC_${i}.jpg))
	dsize=($(echo ${size[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
	echo "<div class=\"magnifier\" style=\"width: ${size[0]}px;height:${size[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/StructuralQC_${i}.jpg\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

	i=2
	${CARET7DIR}/wb_command -show-scene $OutputFolder/Structure/StructuralQC.scene $i ${reportdir}/StructuralQC_${i}.png 1800 1800 > /dev/null 2>&1
	${CARET7DIR}/wb_command -file-information $OutputFolder/Structure/StructuralQC.scene | grep '#' | awk 'NR=='$i' {printf "<I>StructuralQC.scene: %s</I><BR>", $0}' >> $reporthtml
	echo "Subject MyelinMap_BC in top row, group average MyelinMap_BC in 2nd row, Subject Sulc in 3rd row, group average Sulc in 4th row, Areal Distortion of MSMSulc and MSMAll in 5th and 6th rows, respectively. For Areal Distortion, the color bar of areal distoriton is scaled from -1 to 1 in ln(2). <BR>" >> $reporthtml
	convert ${reportdir}/StructuralQC_${i}.png -quality 85 ${reportdir}/StructuralQC_${i}.jpg
	rm -rf ${reportdir}/StructuralQC_${i}.png
	size=($(identify -format '%w %h' $OutputFolder/Structure/report/StructuralQC_${i}.jpg))
	dsize=($(echo ${size[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
	echo "<div class=\"magnifier\" style=\"width: ${size[0]}px;height:${size[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/StructuralQC_${i}.jpg\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
	
	if [ -e $StudyFolder/$Subject/MNINonLinear/${Subject}.MSMAll.164k_fs_LR.wb.spec ] ; then
		SurfReg=MSMAll
		Reg="_MSMAll"
	else
		SurfReg=MSMSulc
		Reg=""
	fi

	if [ -e $OutputFolder/Structure/SurfaceStats.tsv ] ; then
		rm $OutputFolder/Structure/SurfaceStats.tsv
	fi

	# Myelin biasfield & asymmetry
	if [ -e $StudyFolder/$Subject/MNINonLinear/${Subject}.MyelinMap_BC.164k_fs_LR.dscalar.nii ] ; then
 	  if [ ! -e $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii ] ; then
		# By default, ${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii is calculated by MSMAll and DeDriftAndResample pipelines.
		# Thus, absence of this file indicates that MSMAll was not run for the input data. Here we calculates it by a workaround 
		# method for the purpose of QC, but note that it is not applied for DeDriftAndResample that is done by default method. 
		${CARET7DIR}/wb_command -metric-resample $StudyFolder/$Subject/MNINonLinear/Native/${Subject}.L.BiasField.native.func.gii $StudyFolder/$Subject/MNINonLinear/Native/${Subject}.L.sphere.MSMSulc.native.surf.gii $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.sphere.32k_fs_LR.surf.gii ADAP_BARY_AREA $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc.32k_fs_LR.func.gii -area-surfs $StudyFolder/$Subject/MNINonLinear/Native/${Subject}.L.midthickness.native.surf.gii $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.midthickness.32k_fs_LR.surf.gii
		${CARET7DIR}/wb_command -metric-resample $StudyFolder/$Subject/MNINonLinear/Native/${Subject}.R.BiasField.native.func.gii $StudyFolder/$Subject/MNINonLinear/Native/${Subject}.R.sphere.MSMSulc.native.surf.gii $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.R.sphere.32k_fs_LR.surf.gii ADAP_BARY_AREA $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.R.BiasField_MSMSulc.32k_fs_LR.func.gii -area-surfs $StudyFolder/$Subject/MNINonLinear/Native/${Subject}.R.midthickness.native.surf.gii $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.R.midthickness.32k_fs_LR.surf.gii
		${CARET7DIR}/wb_command -cifti-create-dense-scalar $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii -left-metric $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc.32k_fs_LR.func.gii -roi-left $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.atlasroi.32k_fs_LR.shape.gii -right-metric $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.R.BiasField_MSMSulc.32k_fs_LR.func.gii -roi-right $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.R.atlasroi.32k_fs_LR.shape.gii	
	  fi
	
  	  echo -e "MSMSulc_Myelin_Biasfield_Min\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii  -reduce MIN)" >> $OutputFolder/Structure/SurfaceStats.tsv 
	  q1=$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii  -percentile 25)
	  echo -e "MSMSulc_Myelin_Biasfield_Q1\t${q1}" >> $OutputFolder/Structure/SurfaceStats.tsv
	  echo -e "MSMSulc_Myelin_Biasfield_Q2\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii  -reduce MEDIAN)" >> $OutputFolder/Structure/SurfaceStats.tsv
	  q3=$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii  -percentile 75)
	  echo -e "MSMSulc_Myelin_Biasfield_Q3\t${q3}" >> $OutputFolder/Structure/SurfaceStats.tsv
	  echo -e "MSMSulc_Myelin_Biasfield_Max\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.BiasField_MSMSulc.32k_fs_LR.dscalar.nii  -reduce MAX)" >> $OutputFolder/Structure/SurfaceStats.tsv
	  echo -e "MSMSulc_Myelin_Biasfield_IQR\t$(echo "${q3} - ${q1}" | bc -l)" >> $OutputFolder/Structure/SurfaceStats.tsv
	
	  ${CARET7DIR}/wb_command -metric-math '(A-B)/((A+B)/2)' $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc_asymmetry.32k_fs_LR.func.gii -var A $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc.32k_fs_LR.func.gii -var B $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.R.BiasField_MSMSulc.32k_fs_LR.func.gii
	  echo -e "MSMSulc_Myelin_Biasfield_Asymmetry_Min\t$(${CARET7DIR}/wb_command -metric-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc_asymmetry.32k_fs_LR.func.gii -roi $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.atlasroi.32k_fs_LR.shape.gii -reduce MIN)" >> $OutputFolder/Structure/SurfaceStats.tsv 
 	  q1=$(${CARET7DIR}/wb_command -metric-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc_asymmetry.32k_fs_LR.func.gii -roi $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.atlasroi.32k_fs_LR.shape.gii -percentile 25)
	  echo -e "MSMSulc_Myelin_Biasfield_Asymmetry_Q1\t${q1}" >> $OutputFolder/Structure/SurfaceStats.tsv
	  echo -e "MSMSulc_Myelin_Biasfield_Asymmetry_Q2\t$(${CARET7DIR}/wb_command -metric-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc_asymmetry.32k_fs_LR.func.gii -roi $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.atlasroi.32k_fs_LR.shape.gii -reduce MEDIAN)" >> $OutputFolder/Structure/SurfaceStats.tsv
	  q3=$(${CARET7DIR}/wb_command -metric-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc_asymmetry.32k_fs_LR.func.gii -roi $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.atlasroi.32k_fs_LR.shape.gii -percentile 75)
	  echo -e "MSMSulc_Myelin_Biasfield_Asymmetry_Q3\t${q3}" >> $OutputFolder/Structure/SurfaceStats.tsv
	  echo -e "MSMSulc_Myelin_Biasfield_Asymmetry_Max\t$(${CARET7DIR}/wb_command -metric-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.BiasField_MSMSulc_asymmetry.32k_fs_LR.func.gii -roi $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.L.atlasroi.32k_fs_LR.shape.gii -reduce MAX)" >> $OutputFolder/Structure/SurfaceStats.tsv
	  echo -e "MSMSulc_Myelin_Biasfield_Asymmetry_IQR\t$(echo "${q3} - ${q1}" | bc -l)" >> $OutputFolder/Structure/SurfaceStats.tsv

	fi

	# Surface registration 
	echo -e "Surface_registration_method\t$SurfReg" >> $OutputFolder/Structure/SurfaceStats.tsv

	# Areal distortion
	if [ -e $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMSulc.32k_fs_LR.dscalar.nii ] ; then
		echo -e "MSMSulc_areal_distortion_Min\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMSulc.32k_fs_LR.dscalar.nii -reduce MIN)" >> $OutputFolder/Structure/SurfaceStats.tsv 
		q1=$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMSulc.32k_fs_LR.dscalar.nii -percentile 25)
		echo -e "MSMSulc_areal_distortion_Q1\t${q1}" >> $OutputFolder/Structure/SurfaceStats.tsv
		echo -e "MSMSulc_areal_distortion_Q2\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMSulc.32k_fs_LR.dscalar.nii -reduce MEDIAN)" >> $OutputFolder/Structure/SurfaceStats.tsv
		q3=$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMSulc.32k_fs_LR.dscalar.nii -percentile 75)
		echo -e "MSMSulc_areal_distortion_Q3\t${q3}" >> $OutputFolder/Structure/SurfaceStats.tsv
		echo -e "MSMSulc_areal_distortion_Max\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMSulc.32k_fs_LR.dscalar.nii -reduce MAX)" >> $OutputFolder/Structure/SurfaceStats.tsv
		echo -e "MSMSulc_areal_distortion_IQR\t$(echo "${q3} - ${q1}" | bc -l)" >> $OutputFolder/Structure/SurfaceStats.tsv
	fi

	if [ -e $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMAll.32k_fs_LR.dscalar.nii ] ; then
		echo -e "MSMAll_areal_distortion_Min\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMAll.32k_fs_LR.dscalar.nii -reduce MIN)" >> $OutputFolder/Structure/SurfaceStats.tsv
		q1=$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMAll.32k_fs_LR.dscalar.nii -percentile 25)
		echo -e "MSMAll_areal_distortion_Q1\t${q1}" >> $OutputFolder/Structure/SurfaceStats.tsv
		echo -e "MSMAll_areal_distortion_Q2\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMAll.32k_fs_LR.dscalar.nii -reduce MEDIAN)" >> $OutputFolder/Structure/SurfaceStats.tsv
		q3=$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMAll.32k_fs_LR.dscalar.nii -percentile 75)
		echo -e "MSMAll_areal_distortion_Q3\t${q3}" >> $OutputFolder/Structure/SurfaceStats.tsv
		echo -e "MSMAll_areal_distortion_Max\t$(${CARET7DIR}/wb_command -cifti-stats $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.ArealDistortion_MSMAll.32k_fs_LR.dscalar.nii -reduce MAX)" >> $OutputFolder/Structure/SurfaceStats.tsv
		echo -e "MSMAll_areal_distortion_IQR\t$(echo "${q3} - ${q1}" | bc -l)" >> $OutputFolder/Structure/SurfaceStats.tsv
	fi
	
	# Surface stats
	for Map in MyelinMap MyelinMap_BC thickness ; do
		if [ -e $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.dscalar.nii ] ; then
			${CARET7DIR}/wb_command -cifti-parcellate $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.dscalar.nii $LABEL COLUMN  $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.pscalar.nii
			${CARET7DIR}/wb_command -cifti-convert -to-nifti $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.pscalar.nii $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.nii.gz
			${CARET7DIR}/wb_command -cifti-parcellate $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.${Map}_MSMAll.32k_fs_LR.dscalar.nii $LABEL COLUMN $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.${Map}_MSMAll.32k_fs_LR.pscalar.nii
			${CARET7DIR}/wb_command -cifti-convert -to-nifti $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.${Map}_MSMAll.32k_fs_LR.pscalar.nii $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.${Map}_MSMAll.32k_fs_LR.nii.gz
			Similarity=$(fslcc -p 3 $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.nii.gz $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.${Map}_MSMAll.32k_fs_LR.nii.gz | awk '{printf "%1.3f",$3}')
			echo $Similarity | awk '{printf "'$Map'_similarity\t%1.3f\n",$1}' >>  $OutputFolder/Structure/SurfaceStats.tsv
			rm $StudyFolder/$Subject/MNINonLinear/fsaverage_LR32k/${Subject}.${Map}${Reg}.32k_fs_LR.nii.gz $OutputFolder/Structure/Templates/fsaverage_LR32k/S1200.${Map}_MSMAll.32k_fs_LR.nii.gz
		fi
	done

	if [ -e $OutputFolder/Structure/SurfaceStats.tsv ] ; then
	
		# output tab delimited txt to html
		cat $OutputFolder/Structure/SurfaceStats.tsv | tsv2html >> $reporthtml
		echo "<BR>" >> $reporthtml
	fi

	# robust z-score for Myelin_BC
	if [ -e $StudyFolder/$Subject/MNINonLinear/${Subject}.MyelinMap_BC${Reg}.164k_fs_LR.dscalar.nii ] ; then 
		Myelin=$StudyFolder/$Subject/MNINonLinear/${Subject}.MyelinMap_BC${Reg}.164k_fs_LR.dscalar.nii 
		${CARET7DIR}/wb_command -cifti-math '(sub-Q2)/((Q3-Q1)*0.7413)' $OutputFolder/Structure/${Subject}.MyelinMap_BC_z-score.164k_fs_LR.dscalar.nii -var sub $Myelin -var Q1 $MyelinQ1to3 -select 1 1  -var Q2 $MyelinQ1to3 -select 1 2 -var Q3 $MyelinQ1to3 -select 1 3	
	fi
	# robust z-score for thickness
	Thickness=$StudyFolder/$Subject/MNINonLinear/${Subject}.thickness${Reg}.164k_fs_LR.dscalar.nii
	${CARET7DIR}/wb_command -cifti-math '(sub-Q2)/((Q3-Q1)*0.7413)' $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii -var sub $Thickness -var Q1 $ThicknessQ1to3 -select 1 1 -var Q2 $ThicknessQ1to3 -select 1 2 -var Q3 $ThicknessQ1to3 -select 1 3

	# Surface defect map and score
	if [ -e $StudyFolder/$Subject/MNINonLinear/${Subject}.MyelinMap_BC${Reg}.164k_fs_LR.dscalar.nii ] ; then 
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>3)*(abs(B)>3)' $OutputFolder/Structure/SurfaceDefect3.dscalar.nii -var A $OutputFolder/Structure/${Subject}.MyelinMap_BC_z-score.164k_fs_LR.dscalar.nii -var B $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>4)*(abs(B)>4)' $OutputFolder/Structure/SurfaceDefect4.dscalar.nii -var A $OutputFolder/Structure/${Subject}.MyelinMap_BC_z-score.164k_fs_LR.dscalar.nii -var B $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>5)*(abs(B)>5)' $OutputFolder/Structure/SurfaceDefect5.dscalar.nii -var A $OutputFolder/Structure/${Subject}.MyelinMap_BC_z-score.164k_fs_LR.dscalar.nii -var B $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>6)*(abs(B)>6)' $OutputFolder/Structure/SurfaceDefect6.dscalar.nii -var A $OutputFolder/Structure/${Subject}.MyelinMap_BC_z-score.164k_fs_LR.dscalar.nii -var B $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>7)*(abs(B)>7)' $OutputFolder/Structure/SurfaceDefect7.dscalar.nii -var A $OutputFolder/Structure/${Subject}.MyelinMap_BC_z-score.164k_fs_LR.dscalar.nii -var B $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
	else
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>3)' $OutputFolder/Structure/SurfaceDefect3.dscalar.nii -var A $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>4)' $OutputFolder/Structure/SurfaceDefect4.dscalar.nii -var A $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>5)' $OutputFolder/Structure/SurfaceDefect5.dscalar.nii -var A $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>6)' $OutputFolder/Structure/SurfaceDefect6.dscalar.nii -var A $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii
		${CARET7DIR}/wb_command -cifti-math '(abs(A)>7)' $OutputFolder/Structure/SurfaceDefect7.dscalar.nii -var A $OutputFolder/Structure/${Subject}.thickness_z-score.164k_fs_LR.dscalar.nii	
	fi
	
	${CARET7DIR}/wb_command -cifti-merge $OutputFolder/Structure/SurfaceDefect.164k_fs_LR.dscalar.nii -cifti $OutputFolder/Structure/SurfaceDefect3.dscalar.nii -cifti $OutputFolder/Structure/SurfaceDefect4.dscalar.nii -cifti $OutputFolder/Structure/SurfaceDefect5.dscalar.nii -cifti $OutputFolder/Structure/SurfaceDefect6.dscalar.nii -cifti $OutputFolder/Structure/SurfaceDefect7.dscalar.nii
	${CARET7DIR}/wb_command -cifti-separate $OutputFolder/Structure/SurfaceDefect.164k_fs_LR.dscalar.nii COLUMN -metric CORTEX_LEFT $OutputFolder/Structure/SurfaceDefect.L.164k_fs_LR.shape.gii  -metric CORTEX_RIGHT $OutputFolder/Structure/SurfaceDefect.R.164k_fs_LR.shape.gii

	for hemi in L R ; do 
		${CARET7DIR}/wb_command -metric-to-volume-mapping $OutputFolder/Structure/SurfaceDefect.${hemi}.164k_fs_LR.shape.gii $StudyFolder/$Subject/MNINonLinear/${Subject}.${hemi}.midthickness.164k_fs_LR.surf.gii $StudyFolder/$Subject/MNINonLinear/T1w_restore.nii.gz $OutputFolder/Structure/SurfaceDefect.${hemi}.nii.gz -ribbon-constrained $StudyFolder/$Subject/MNINonLinear/${Subject}.${hemi}.pial.164k_fs_LR.surf.gii $StudyFolder/$Subject/MNINonLinear/${Subject}.${hemi}.white.164k_fs_LR.surf.gii
	done

	${FSLDIR}/bin/fslmaths $OutputFolder/Structure/SurfaceDefect.L.nii.gz -max $OutputFolder/Structure/SurfaceDefect.R.nii.gz -bin $OutputFolder/Structure/SurfaceDefect_MNINonLinear.nii.gz

	${FSLDIR}/bin/applywarp -i $OutputFolder/Structure/SurfaceDefect_MNINonLinear.nii.gz -r $StudyFolder/$Subject/T1w/T1w_acpc_dc.nii.gz -w $StudyFolder/$Subject/MNINonLinear/xfms/standard2acpc_dc.nii.gz -o $OutputFolder/Structure/SurfaceDefect_acpc_dc.nii.gz --interp=nn
	imrm $OutputFolder/Structure/SurfaceDefect.L.nii.gz $OutputFolder/Structure/SurfaceDefect.R.nii.gz $OutputFolder/Structure/SurfaceDefect_MNINonLinear.nii.gz
	rm $OutputFolder/Structure/SurfaceDefect.L.164k_fs_LR.shape.gii $OutputFolder/Structure/SurfaceDefect.R.164k_fs_LR.shape.gii

	if [ -e $StudyFolder/$Subject/MNINonLinear/${Subject}.MyelinMap_BC${Reg}.164k_fs_LR.dscalar.nii ] ; then 
		echo "Surface Defect (MyelinMap_BC & thickness|z|>3)" > $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (MyelinMap_BC & thickness|z|>4)" >> $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (MyelinMap_BC & thickness|z|>5)" >> $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (MyelinMap_BC & thickness|z|>6)" >> $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (MyelinMap_BC & thickness|z|>7)" >> $OutputFolder/Structure/SurfaceDefect.txt
	else
		echo "Surface Defect (thickness|z|>3)" > $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (thickness|z|>4)" >> $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (thickness|z|>5)" >> $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (thickness|z|>6)" >> $OutputFolder/Structure/SurfaceDefect.txt
		echo "Surface Defect (thickness|z|>7)" >> $OutputFolder/Structure/SurfaceDefect.txt
	fi

	${CARET7DIR}/wb_command -set-map-names $OutputFolder/Structure/SurfaceDefect.164k_fs_LR.dscalar.nii -name-file $OutputFolder/Structure/SurfaceDefect.txt
	${CARET7DIR}/wb_command -set-map-names $OutputFolder/Structure/SurfaceDefect_acpc_dc.nii.gz -name-file $OutputFolder/Structure/SurfaceDefect.txt

	i=3
	${CARET7DIR}/wb_command -show-scene $OutputFolder/Structure/StructuralQC.scene ${i} ${reportdir}/StructuralQC_${i}.png 1800 1200 > /dev/null 2>&1
	${CARET7DIR}/wb_command -file-information $OutputFolder/Structure/StructuralQC.scene | grep '#' | awk 'NR=='$i' {printf "<I>StructuralQC.scene: %s</I><BR>", $0}' >> $reporthtml
	echo "Estimated 'surface defect' based on the robust z-score of MyelinMap_BC and thickness in HCP-S1200 data. Vertices with an absolute z-score larger than 5 (|z|>5) in both metrics are shown in blue. The number of vertices with this threshold is termed as a surface defect score 5 (SDS5). <BR>" >> $reporthtml
	convert ${reportdir}/StructuralQC_${i}.png -quality 85 ${reportdir}/StructuralQC_${i}.jpg
	rm -rf ${reportdir}/StructuralQC_${i}.png $OutputFolder/Structure/SurfaceDefect.txt
	size=($(identify -format '%w %h' $OutputFolder/Structure/report/StructuralQC_${i}.jpg))
	dsize=($(echo ${size[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
	echo "<div class=\"magnifier\" style=\"width: ${size[0]}px;height:${size[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/StructuralQC_${i}.jpg\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

	zlist="3 4 5 6 7";
	for z in $zlist ; do
		SurfaceDefectScore=$(${CARET7DIR}/wb_command -cifti-stats $OutputFolder/Structure/SurfaceDefect${z}.dscalar.nii -reduce COUNT_NONZERO)
		echo $SurfaceDefectScore | awk '{printf "Surface_defect_score_'${z}'_(SDS'${z}')\t%d\n",$1}' >> $OutputFolder/Structure/SurfaceStats.tsv
		rm $OutputFolder/Structure/SurfaceDefect${z}.dscalar.nii
	done
	
	if [ -e $OutputFolder/Structure/SurfaceStats.tsv ] ; then
		cat $OutputFolder/Structure/SurfaceStats.tsv | tail -$(echo $zlist | wc -w) | tsv2html >> $reporthtml
		echo "<BR>" >> $reporthtml
	fi
		
	i=4
	${CARET7DIR}/wb_command -show-scene $OutputFolder/Structure/StructuralQC.scene ${i} ${reportdir}/StructuralQC_${i}.png 1800 1200 > /dev/null 2>&1
	${CARET7DIR}/wb_command -file-information $OutputFolder/Structure/StructuralQC.scene | grep '#' | awk 'NR=='$i' {printf "<I>StructuralQC.scene: %s</I><BR>", $0}' >> $reporthtml
	echo "Midthickness surfaces (black contour) and Jacobian map (magenta and orange). Jacobian map only shows those values less than 0.5 or higher than 2.<BR>" >> $reporthtml
	convert ${reportdir}/StructuralQC_${i}.png -quality 85 ${reportdir}/StructuralQC_${i}.jpg
	rm -rf ${reportdir}/StructuralQC_${i}.png
	size=($(identify -format '%w %h' $OutputFolder/Structure/report/StructuralQC_${i}.jpg))
	dsize=($(echo ${size[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
	echo "<div class=\"magnifier\" style=\"width: ${size[0]}px;height:${size[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/StructuralQC_${i}.jpg\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

	if [ -e $OutputFolder/Structure/NonlinearRegJacobians_stats.tsv ] ; then
		rm $OutputFolder/Structure/NonlinearRegJacobians_stats.tsv
	fi
	${FSLDIR}/bin/flirt -in $StudyFolder/$Subject/MNINonLinear/brainmask_fs.nii.gz -ref $StudyFolder/$Subject/MNINonLinear/xfms/2mmReg.nii.gz -applyxfm -init $FSLDIR/etc/flirtsch/ident.mat -o $StudyFolder/$Subject/MNINonLinear/xfms/brainmask_fs22mmReg -interp nearestneighbour
	echo -e "NonlinearRegJacobians\t" > $OutputFolder/Structure/NonlinearRegJacobians_stats.tsv	
	${FSLDIR}/bin/fslstats $StudyFolder/$Subject/MNINonLinear/xfms/NonlinearRegJacobians.nii.gz -k $StudyFolder/$Subject/MNINonLinear/xfms/brainmask_fs22mmReg -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ1\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> $OutputFolder/Structure/NonlinearRegJacobians_stats.tsv
	cat $OutputFolder/Structure/NonlinearRegJacobians_stats.tsv | tsv2html >> $reporthtml

	echo "<BR><BR><BR><BR><BR><BR><BR><BR></BODY></HTML>" >>  $reporthtml
			
fi
}

############################################################
# QC for Diffusion
############################################################

DiffQC () {

if [[ $Diff = ON  && $(imtest $StudyFolder/$Subject/T1w/Diffusion/data.nii.gz) = 0 ]] ; then
 	echo "WARNING: not found preprocessed diffusion data (T1w/Diffusion/data.nii.gz).. skip QC for diffusion" 
 	return

elif [[ $Diff = ON  && $(imtest $StudyFolder/$Subject/T1w/Diffusion/data.nii.gz) = 1 ]] ; then
 #&& -e $StudyFolder/$Subject/Diffusion
	logMsg "Calculating Diffusion QC"

	if [ -e $OutputFolder/Diffusion ] ; then rm -rf $OutputFolder/Diffusion;fi
	mkdir -p $OutputFolder/Diffusion

	WD=$OutputFolder/Diffusion
	reportdir=${WD}/report
	reporthtml=${WD}/report.html
	mkdir -p $reportdir	
	touch $reporthtml

	echo "<HTML><HEAD><link REL=\"stylesheet\" TYPE=\"text/css\" href=\"../.files/fsl.css\"><TITLE>HCPPIPE QC REPORT</TITLE><link rel="icon" type="image/x-icon" href="../.files/favicon.ico"> <link href="../.files/lightbox.css" rel=stylesheet>
 <script src="../.files/jquery.min.js"></script><script src="../.files/lightbox.min.js" type="text/javascript"></script><link type="text/css" href="../.files/magnifier.css" rel="stylesheet"><script type="text/javascript" src="../.files/magnifier.js"></script></HEAD><BODY BGCOLOR=\"#FFFFFF\" TEXT=\"#151515\">" >> $reporthtml

	echo "<a name=\"Inputs\"><div id=\"Inputs\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Diffusion</span></B> - | <B>Inputs</B> | <a href=\"#Distortion\">Distortion & Fieldmap</a> | <a href=\"#Registration\">Registration</a> | <a href=\"#DiffusionQC\">Diffusion QC & Tensor</a> | <a href=\"#CrossingFibers\">Crossing Fibers & Tracts</a>  <BR><BR> " >> $reporthtml

	# inputs
	if [ ! -z "$T1wInputImages" ] ; then # imported imputs data from hcppipe_conf.txt
		echo "<I>Inputs to preprocessing</I><BR>" >> $reporthtml
		echo -e "Modality\tFilename\tEchoSpacing\tPhaseDir\tGradientCoil" > $reportdir/inputs_dMRI.tsv
		echo -e "dMRI Postive\t${DmrilistPositive}\t${EchoSpacing:-NONE}\t${PEdir:-NONE}\t${Gradient:-NONE}" >> $reportdir/inputs_dMRI.tsv
		echo -e "dMRI Negative\t${DmrilistNegative}\t${EchoSpacing:-NONE}\t${PEdir:-NONE}\t${Gradient:-NONE}" >> $reportdir/inputs_dMRI.tsv
		cat $reportdir/inputs_dMRI.tsv | tsv2html >> $reporthtml
		echo "PhaseDir label: 1=x; 2=y<BR><BR>" >> $reporthtml
	fi

	if [ -e $StudyFolder/$Subject/RawData/Seriesinfo.csv ] ; then
		echo "<I>Scanning parameters for input volumes</I><BR>" >> $reporthtml
		echo -e "Filename\tSeriesNum\tProtocol\tTR[ms]\tTE[ms]\tTI[ms]\tFA[deg]\tMatrix\tPixelSize[mm]\tSliceThickness[mm]\tPreScanNorm\tDwelltimeRead[sec]\tDwelltimePhase[sec]\tReadDir\tPhaseDir\tSliceDir\tTxAmp[V]\tParallelFactor\tMultiBandFactor" > $reportdir/scaninfo.tsv
		for i in ${DmrilistPositive} ${DmrilistNegative} ; do
			if [ ! -z "$(ls -loh --time-style=iso $(imglob -extension $StudyFolder/$Subject/RawData/$i) | awk '{print $9}')" ] ; then
				scannum=$(echo $(basename $(ls -loh --time-style=iso $(imglob -extension $StudyFolder/$Subject/RawData/$i) | awk '{print $9}') | cut -d '_' -f 1))
				if [[ ! -z $(cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {print $15}' | grep NORM) ]] ; then
					PreScanNorm=ON
				else
					PreScanNorm=OFF
				fi
				pixsize=($(printf "%0.2f " $(cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {print $12}')))
				pixsize="${pixsize[0]}x${pixsize[1]}"
				cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {printf "%s\t%d\t%s\t%0.0f\t%0.2f\t%0.0f\t%d\t%s\t%s\t%0.2f\t%s\t%0.7f\t%0.7f\t%s\t%s\t%s\t%0.1f\t%d\t%d\n","'$i'",$1,$4,$7,$8,$9,$10,$11,"'${pixsize}'",$13,"'$PreScanNorm'",$16,$17,$18,$19,$20,$22,$23,$24}' >> $reportdir/scaninfo.tsv
			else
				echo -e "$i\tNo link to\tprotocol.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t" >> $reportdir/scaninfo.tsv
			fi
		done
		cat $reportdir/scaninfo.tsv | tsv2html >> $reporthtml
		echo "<BR>" >> $reporthtml
	fi


	DistCorDir=$StudyFolder/$Subject/Diffusion/topup
	if [ -e $DistCorDir ] ; then

		logMsg "Calculating fieldmap, diff2str registration"
		# Pos_Neg_b0 to check registration & distortion correction quality
		echo "<a name=\"Distortion\"><div id=\"Distortion\"></div></a>" >> $reporthtml
		echo "<hr><B><span style=\"color:gray\">Diffusion</span></B> - | <a href=\"#Inputs\">Inputs</a> | <B>Distortion & Fieldmap</B> | <a href=\"#Registration\">Registration</a> | <a href=\"#DiffusionQC\">Diffusion QC & Tensor</a> | <a href=\"#CrossingFibers\">Crossing Fibers & Tracts</a>  <BR><BR> " >> $reporthtml

		${FSLDIR}/bin/flirt -in ${DistCorDir}/nodif_brain.nii.gz -ref ${DistCorDir}/../data/nodif_brain.nii.gz -dof 6 -omat ${DistCorDir}/topup2diff.mat
		${FSLDIR}/bin/convert_xfm -omat ${DistCorDir}/topup2str.mat -concat ${DistCorDir}/../reg/diff2str.mat ${DistCorDir}/topup2diff.mat

		FMtype="SE field"
		if [[ $(cat ${DistCorDir}/acqparams.txt | awk '{x = $1; S += x*x; N++;} END {print sqrt(S/N)}') != 0 ]] ; then
			PhaseDir=x
		elif [[ $(cat ${DistCorDir}/acqparams.txt | awk '{x = $2; S += x*x; N++;} END {print sqrt(S/N)}') != 0 ]] ; then
			PhaseDir=y
		else
			PhaseDir=Unknown
		fi
		echo "dMRI phase encoding direction: <B>${PhaseDir}</B><BR><BR>" >> $reporthtml
		dimt=$(${FSLDIR}/bin/fslval ${DistCorDir}/Pos_Neg_b0 dim4)
		dimn=$((dimt/2))
		${FSLDIR}/bin/fslroi ${DistCorDir}/Pos_Neg_b0.nii.gz ${DistCorDir}/Pos_Neg_b0_pos.nii.gz 0 1
		${FSLDIR}/bin/fslroi ${DistCorDir}/Pos_Neg_b0.nii.gz ${DistCorDir}/Pos_Neg_b0_neg.nii.gz $dimn 1
		${FSLDIR}/bin/flirt -in ${DistCorDir}/Pos_Neg_b0_pos.nii.gz -ref ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -applyxfm -init ${DistCorDir}/topup2str.mat -o ${DistCorDir}/Pos_Neg_b0_hires_pos.nii.gz 
		${FSLDIR}/bin/flirt -in ${DistCorDir}/Pos_Neg_b0_neg.nii.gz -ref ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -applyxfm -init ${DistCorDir}/topup2str.mat -o ${DistCorDir}/Pos_Neg_b0_hires_neg.nii.gz 
		${FSLDIR}/bin/slicer ${DistCorDir}/Pos_Neg_b0_hires_pos.nii.gz ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -s 2 -e .05 -a ${DistCorDir}/Pos_Neg_b0_hires_pos.png
		${FSLDIR}/bin/slicer ${DistCorDir}/Pos_Neg_b0_hires_neg.nii.gz ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -s 2 -e .05 -a ${DistCorDir}/Pos_Neg_b0_hires_neg.png
		convert -loop 0 -delay 100 ${DistCorDir}/Pos_Neg_b0_hires_pos.png ${DistCorDir}/Pos_Neg_b0_hires_neg.png ${reportdir}/Pos_Neg_b0_hires.gif

		${FSLDIR}/bin/applytopup --imain=${DistCorDir}/Pos_Neg_b0_pos --topup=${DistCorDir}/topup_Pos_Neg_b0 --datain=${DistCorDir}/acqparams.txt --inindex=1 --out=${DistCorDir}/hifib0_pos_jac --method=jac
		${FSLDIR}/bin/applytopup --imain=${DistCorDir}/Pos_Neg_b0_neg --topup=${DistCorDir}/topup_Pos_Neg_b0 --datain=${DistCorDir}/acqparams.txt --inindex=$((dimn+1)) --out=${DistCorDir}/hifib0_neg_jac --method=jac
		${FSLDIR}/bin/flirt -in ${DistCorDir}/hifib0_pos_jac.nii.gz -ref ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -applyxfm -init ${DistCorDir}/topup2str.mat -o ${DistCorDir}/hifib0_hires_pos.nii.gz
		${FSLDIR}/bin/flirt -in ${DistCorDir}/hifib0_neg_jac.nii.gz -ref ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -applyxfm -init ${DistCorDir}/topup2str.mat -o ${DistCorDir}/hifib0_hires_neg.nii.gz
		${FSLDIR}/bin/slicer ${DistCorDir}/hifib0_hires_pos.nii.gz ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -s 2 -e .05 -a ${DistCorDir}/hifib0_hires_pos.png
		${FSLDIR}/bin/slicer ${DistCorDir}/hifib0_hires_neg.nii.gz ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz -s 2 -e .05 -a ${DistCorDir}/hifib0_hires_neg.png
		convert -loop 0 -delay 100 ${DistCorDir}/hifib0_hires_pos.png ${DistCorDir}/hifib0_hires_neg.png ${reportdir}/hifib0_hires.gif
		fslmaths ${DistCorDir}/hifib0_neg_jac -sub ${DistCorDir}/hifib0_pos_jac -abs ${DistCorDir}/hifib0_phase_diff_abs
		
		gifmergeh ${reportdir}/Pos_Neg_b0_hires.gif ${reportdir}/hifib0_hires.gif ${reportdir}/Pos_Neg_hifib0_hires.gif
		rm ${reportdir}/Pos_Neg_b0_hires.gif ${reportdir}/hifib0_hires.gif
		size=($(identify -format '%w %h' ${reportdir}/Pos_Neg_hifib0_hires.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<I>Distorted and undistorted b0 volumes</I><BR>"  >> $reporthtml
		echo "Confirm that original b0 volume is a pair of volumes distorted along opposed phased encoding direction (left) and this distortion is reasonably corrected by TOPUP (right). If distortion correction is likely good but alignment is not well, please check that eddy worked properly. " >> $reporthtml
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/Pos_Neg_hifib0_hires.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
	
		# B0 fieldmap and magnitude
		fslmaths ${DistCorDir}/topup_Pos_Neg_b0_field.nii.gz -mul 6.28 ${DistCorDir}/TopupField.nii.gz
		$FSLDIR/bin/applywarp -i ${DistCorDir}/TopupField.nii.gz -r ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz --premat=${DistCorDir}/topup2str.mat -o $DistCorDir/FieldMap2T1w_acpc.nii.gz
		$FSLDIR/bin/fslmaths $DistCorDir/FieldMap2T1w_acpc -thr 0 $DistCorDir/FieldMap2T1w_acpc_p
		$FSLDIR/bin/fslmaths $DistCorDir/FieldMap2T1w_acpc -uthr 0 -mul -1 $DistCorDir/FieldMap2T1w_acpc_m			
		$FSLDIR/bin/overlay 1 0 $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -a $DistCorDir/FieldMap2T1w_acpc_p .0001 500 $DistCorDir/FieldMap2T1w_acpc_m .0001 500 $DistCorDir/FieldMap2T1w_acpc_overlay.nii.gz
		$FSLDIR/bin/slicer $DistCorDir/FieldMap2T1w_acpc_overlay.nii.gz -a ${reportdir}/FieldMap2T1w_acpc_overlay.png			
		$FSLDIR/bin/applywarp -i $DistCorDir/hifib0.nii.gz -r ${DistCorDir}/../reg/T1w_acpc_dc_restore_brain.nii.gz --premat=${DistCorDir}/topup2str.mat -o $DistCorDir/Mag2T1w_acpc.nii.gz
		${FSLDIR}/bin/slicer $DistCorDir/Mag2T1w_acpc.nii.gz $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -a ${reportdir}/MagT1w_acpc.png
		$FSLDIR/bin/pngappend ${reportdir}/FieldMap2T1w_acpc_overlay.png + ${reportdir}/MagT1w_acpc.png ${reportdir}/FieldMapMag2T1w_acpc_overlay.png
		convert ${reportdir}/FieldMapMag2T1w_acpc_overlay.png ${reportdir}/FieldMapMag2T1w_acpc_overlay.gif
		rm ${reportdir}/FieldMapMag2T1w_acpc_overlay.png ${reportdir}/MagT1w_acpc.png
		echo "<I>B0 fieldmap and magnitude</I><BR>" >> $reporthtml
		echo "Check that fieldmap (red/blue color in left panel) is high in inferior frontal & temporal areas but not very high in other areas. The IQR of fieldmap is useally less than 200 rad/sec. Check that the magnitude is well reconstructed and aligned with T1w_acpc (red contour, right panel). <BR>" >> $reporthtml
		size=($(identify -format '%w %h' ${reportdir}/FieldMapMag2T1w_acpc_overlay.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/FieldMapMag2T1w_acpc_overlay.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
		cp $FSLDIR/etc/luts/ramp*.gif ${reportdir}/
		echo "-500<img src=\"./report/ramp2.gif\"><img src=\"./report/ramp.gif\">500 <BR>" >> $reporthtml
		echo -e "${FMtype} B0 fieldmap [rad/sec] in brain area\t" > $OutputFolder/Diffusion/Fieldmap_stats.tsv
		${FSLDIR}/bin/fslstats ${DistCorDir}/TopupField.nii.gz -k ${DistCorDir}/nodif_brain_mask.nii.gz -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ1\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> $OutputFolder/Diffusion/Fieldmap_stats.tsv
		# fieldmap gradient
		${CARET7DIR}/wb_command -volume-gradient ${DistCorDir}/TopupField.nii.gz ${DistCorDir}/TopupField_grad.nii.gz
		echo -e "B0 fieldmap gradient in brain area\t" >> $OutputFolder/Diffusion/Fieldmap_stats.tsv
		${FSLDIR}/bin/fslstats ${DistCorDir}/TopupField_grad.nii.gz -k ${DistCorDir}/nodif_brain_mask.nii.gz -m | awk '{printf "Gradient (mean)\t%1.2f\n",$1}' >> $OutputFolder/Diffusion/Fieldmap_stats.tsv		
		# phase diff abs
		echo -e "Phase diff abs in brain area\t" >> $OutputFolder/Diffusion/Fieldmap_stats.tsv
		${FSLDIR}/bin/fslstats ${DistCorDir}/hifib0_phase_diff_abs -k ${DistCorDir}/nodif_brain_mask.nii.gz -m | awk '{printf "Phase diff abs (mean)\t%1.2f\n",$1}' >> $OutputFolder/Diffusion/Fieldmap_stats.tsv
		cat  $OutputFolder/Diffusion/Fieldmap_stats.tsv | tsv2html >> $reporthtml

		# QC for registration betweeen diffusion and T1w_acpc
		echo "<a name=\"Registration\"><div id=\"Registration\"></div></a>" >> $reporthtml
		echo "<hr><B><span style=\"color:gray\">Diffusion</span></B> - | <a href=\"#Inputs\">Inputs</a>  | <a href=\"#Distortion\">Distortion & Fieldmap</a> | <B>Registration</B> | <a href=\"#DiffusionQC\">Diffusion QC & Tensor</a> | <a href=\"#CrossingFibers\">Crossing Fibers & Tracts</a> <BR><BR>" >> $reporthtml

		echo "<I>b0 vs T1w volumes</I><BR>"  >> $reporthtml	
		echo "Check that distortion-corrected b0 image aligns well with the T1w_acpc_restore_brain (left, <B>sqrt(T1w*b0)</B>; right, <B>b0</B> w/ red contours of T1w_acpc_restore_brain).<BR>"  >> $reporthtml

		fslmaths $DistCorDir/Mag2T1w_acpc.nii.gz -mul $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore_brain $DistCorDir/T1wMulb0.nii.gz
		${FSLDIR}/bin/slicer $DistCorDir/T1wMulb0.nii.gz $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore_brain -s 2 -e 0.05 -a ${OutputFolder}/Diffusion/T1wMulb0.png
		${FSLDIR}/bin/slicer $DistCorDir/Mag2T1w_acpc.nii.gz $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore_brain -s 2 -e 0.05 -a ${OutputFolder}/Diffusion/b02T1w.png
		${FSLDIR}/bin/pngappend ${OutputFolder}/Diffusion/T1wMulb0.png + ${OutputFolder}/Diffusion/b02T1w.png ${OutputFolder}/Diffusion/b0andT1w.png
		convert ${OutputFolder}/Diffusion/b0andT1w.png  ${reportdir}/b0andT1w.gif
		rm ${OutputFolder}/Diffusion/b0andT1w.png ${OutputFolder}/Diffusion/b02T1w.png ${OutputFolder}/Diffusion/T1wMulb0.png
	
		size=($(identify -format '%w %h' ${reportdir}/b0andT1w.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$2*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/b0andT1w.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
	
	fi

	# QC for registration between b0 and cortical surfaces
	logMsg "Calculating b0 and surface registration"

	if [ $(imtest $StudyFolder/$Subject/T1w/Diffusion/dti_FA) != 1 ] ; then
		${FSLDIR}/bin/dtifit -k $StudyFolder/$Subject/T1w/Diffusion/data -o $StudyFolder/$Subject/T1w/Diffusion/dti -b $StudyFolder/$Subject/T1w/Diffusion/bvals -r $StudyFolder/$Subject/T1w/Diffusion/bvecs -m $StudyFolder/$Subject/T1w/Diffusion/nodif_brain_mask
	fi

	${FSLDIR}/bin/flirt -in $StudyFolder/$Subject/T1w/Diffusion/dti_FA -applyxfm -init ${FSLDIR}/etc/flirtsch/ident.mat -ref $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore -o $OutputFolder/Diffusion/dti_FA_hires -interp spline

	if [ -e $TemplateFolder/scenes/TEMPLATE_DiffusionBBRQC.scene ] ; then
		cat $TemplateFolder/scenes/TEMPLATE_DiffusionBBRQC.scene | sed s/SubjectID/${Subject}/g >  $OutputFolder/Diffusion/DiffusionBBRQC.scene
		# NOTES: how to create TemplateScene
		# cat subjectDiffusionBBRQC.scene  | sed s/A18031601/SubjectID/g > TEMPLATE_fMRINameBBRQC.scene

		${CARET7DIR}/wb_command -show-scene $OutputFolder/Diffusion/DiffusionBBRQC.scene 1 $OutputFolder/Diffusion/report/DiffusionBBRQC.png 3800 1300 > /dev/null 2>&1
		convert $OutputFolder/Diffusion/report/DiffusionBBRQC.png $OutputFolder/Diffusion/report/DiffusionBBRQC.gif
		rm -rf $OutputFolder/Diffusion/report/DiffusionBBRQC.png
		#$StudyFolder/$Subject/${fmriname}/Scout2T1w_nomask.nii.gz ${WDfMRI}/${fmriname}BBRQC.scene
		
		size=($(identify -format '%w %h' $OutputFolder/Diffusion/report/DiffusionBBRQC.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$2*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<I>dti_FA vs surfaces</I><BR>"  >> $reporthtml
		echo "Check that cortical ribbon of the distortion-corrected dti_FA volume aligns well with white and pial surfaces. Subtle misregistration can cause partial voluming effect in the signals of cortical ribbon. It is often useful to closely investigate sagittal (1st row) and axial sections (3rd row) if fMRI's phase-encode is in y-axis, and axial and coronal sections (2nd row) if fMRI's phase-encode is in x-axis. <BR>"  >> $reporthtml
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/DiffusionBBRQC.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
		echo "The above images can be closely viewed by running the following command:  <BR>"  >> $reporthtml
		echo "<div style=\"background: ghostwhite; font-size: 12px; padding: 12px;; border: 1px solid lightgray; margin: 1px;\"<p><code> $ wb_view $Subject/QC/Diffusion/DiffusionBBRQC.scene </code></p></div><BR>" >> $reporthtml

	fi
	
	if [ -e  $StudyFolder/$Subject/Diffusion/reg ] ; then
		logMsg "Calculating mincost of FSL BBR"
		echo -e "FSL_BBR_mincost\t$(flirt -in $StudyFolder/$Subject/Diffusion/data/nodif_brain.nii.gz -ref $StudyFolder/$Subject/Diffusion/reg/T1w_acpc_dc_restore_brain.nii.gz -schedule $FSLDIR/etc/flirtsch/measurecost1.sch -init  $StudyFolder/$Subject/Diffusion/reg/nodif2T1w_initII.mat -wmseg $StudyFolder/$Subject/Diffusion/reg/nodif2T1w_initII_fast_wmseg.nii.gz -cost bbr | head -1 | awk '{print $1}')" > $OutputFolder/Diffusion/nodif2T1w.mincost.tsv
		if [ -e $StudyFolder/$Subject/Diffusion/reg/EPItoT1w.dat.mincost ] ; then
			logMsg "Calculating mincost of FreeSurfer BBR"
			echo -e "FreeSurfer_BBR_mincost\t$(cat $StudyFolder/$Subject/Diffusion/reg/EPItoT1w.dat.mincost | awk '{print $1}')" >> $OutputFolder/Diffusion/nodif2T1w.mincost.tsv
		fi
		cat $OutputFolder/Diffusion/nodif2T1w.mincost.tsv | tsv2html >> $reporthtml
	fi
		
	echo "<a name=\"DiffusionQC\"><div id=\"DiffusionQC\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Diffusion</span></B> - | <a href=\"#Inputs\">Inputs</a>  | <a href=\"#Distortion\">Distortion & Fieldmap</a> | <a href=\"#Registration\">Registration</a> | <B>Diffusion QC & Tensor</B> | <a href=\"#CrossingFibers\">Crossing Fibers & Tracts</a> <BR><BR>" >> $reporthtml


	if [ -d $StudyFolder/$Subject/Diffusion ] ; then
		logMsg "Calculating eddy_quad"
		if [ $(imtest $StudyFolder/$Subject/Diffusion/eddy/eddy_unwarped_images) = 1 ] ; then
			if [ ! -d  $StudyFolder/$Subject/Diffusion/QC ] ; then
			#. /opt/rh/rh-python36/enable
			eddy_quad $StudyFolder/$Subject/Diffusion/eddy/eddy_unwarped_images -i $StudyFolder/$Subject/Diffusion/eddy/index.txt -par $StudyFolder/$Subject/Diffusion/eddy/acqparams.txt -m $StudyFolder/$Subject/Diffusion/eddy/nodif_brain_mask.nii.gz -b $StudyFolder/$Subject/Diffusion/eddy/Pos_Neg.bvals -o $StudyFolder/$Subject/Diffusion/QC
			fi
			cp -r $StudyFolder/$Subject/Diffusion/QC/* $OutputFolder/Diffusion/
			CNR=$(for i in $(cat $StudyFolder/$Subject/QC/Diffusion/qc.json | jq -r "[.data_unique_bvals[]] | @csv" | sed -e 's/,/ /g'); do echo -n "Average CNR (b=$i [s/mm^2]),"; done)
			echo "Average SNR(b=0 [s/mm2]),${CNR}Average abs. motion,Average rel. motion,Total outliers [%],Std Dev voxel displacement" > $StudyFolder/$Subject/QC/Diffusion/tmp.csv
			for i in $(cat $StudyFolder/$Subject/QC/Diffusion/qc.json | jq -r  "[.qc_cnr_avg[],.qc_mot_abs,.qc_mot_rel,.qc_outliers_tot,.qc_vox_displ_std ] | @csv" | sed -e 's/,/ /g') ; do  echo $i | awk '{printf "%0.2f,",$1}'; done >> $OutputFolder/Diffusion/tmp.csv
			cat $OutputFolder/Diffusion/tmp.csv | awk -F, '{ for (i=1; i<=NF; i++)  { a[NR,i] = $i } } NF>p { p = NF }END {for(j=1; j<=p; j++) { str=a[1,j]; for(i=2; i<=NR; i++){ str=str"\t"a[i,j]; } printf "%s\n", str}}' > $OutputFolder/Diffusion/DiffusionQC.tsv
			rm $OutputFolder/Diffusion/tmp.csv
			wc=$(cat $OutputFolder/Diffusion/DiffusionQC.tsv | wc -l)
			echo "<I>Diffusion QC</I><BR>"  >> $reporthtml
			cat $OutputFolder/Diffusion/DiffusionQC.tsv | tsv2html >> $reporthtml
			echo "For detials, see <B><a href=\"./qc.pdf\" target=\"_blank\">Eddy QC report</a></B><BR><BR>" >> $reporthtml
		else
			if [ -e $StudyFolder/$Subject/T1w/Diffusion/data_snr.nii.gz ] ; then		
				echo -e "b0 tSNR\t $(fslstats $StudyFolder/$Subject/T1w/Diffusion/data_snr.nii.gz  -k $StudyFolder/$Subject/T1w/Diffusion/nodif_brain_mask -m)" > $OutputFolder/Diffusion/DiffusionQC.tsv
				wc=$(cat $OutputFolder/Diffusion/DiffusionQC.tsv | wc -l)
				echo "<I>Diffusion QC</I><BR>"  >> $reporthtml
				cat $OutputFolder/Diffusion/DiffusionQC.tsv | tsv2html >> $reporthtml
				echo "<BR>" >> $reporthtml
			fi
		fi
	fi
	
	# diffusion tensor
	if [[ -e  $StudyFolder/$Subject/T1w/Diffusion/dti_FA.nii.gz && -e  $StudyFolder/$Subject/T1w/Diffusion/dti_tensor.nii.gz ]] ; then

		logMsg "Creating diffusion tensor image"

		z=24
		if [[ $SPECIES != Human ]] ; then z=0; fi
		$FSLDIR/bin/fsleyes render -of $StudyFolder/$Subject/T1w/Diffusion/dti_tensor.png -sz 3800 1000 -wl 0 -8 $z -sz 3800 1000 -xz 1700 -yz 1700 -zz 1700 -no $StudyFolder/$Subject/T1w/Diffusion/dti_FA.nii.gz $StudyFolder/$Subject/T1w/Diffusion/dti_tensor.nii.gz -ot tensor -s 500
		convert $StudyFolder/$Subject/T1w/Diffusion/dti_tensor.png $reportdir/dti_tensor.gif
		size=(3800 1000)
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$2*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<I>Diffusion tensor </I><BR>"  >> $reporthtml
		echo "Check that the principal direction of diffusion tensor is well aligned to the known commissural tract in the antenior, middle, and posterior parts of the corpus callosum. Tensors are color coded by the principal direction (RGB in XYZ directions). <BR>"  >> $reporthtml
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/dti_tensor.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

		echo "The above image can be closely viewed by running the following command: <BR>" >> $reporthtml
		echo "<div style=\"background: ghostwhite; font-size: 12px; padding: 12px;; border: 1px solid lightgray; margin: 1px;\"<p><code> $ fsleyes -wl 0 -8 24 -xz 1000 -yz 1000 -zz 1000 -no $Subject/T1w/Diffusion/dti_FA.nii.gz $Subject/T1w/Diffusion/dti_tensor.nii.gz -ot tensor -s 200</code></p></div>"  >> $reporthtml

	fi
	
	if [[ $(imtest $StudyFolder/$Subject/T1w/Diffusion.bedpostX/mean_f1samples) = 1 ]] ; then

		logMsg "Calculating Tractography QC"
		echo "<a name=\"CrossingFibers\"><div id=\"CrossingFibers\"></div></a>" >> $reporthtml
		echo "<hr><B><span style=\"color:gray\">Diffusion</span></B> - | <a href=\"#Inputs\">Inputs</a> | <a href=\"#Distortion\">Distortion & Fieldmap</a> | <a href=\"#Registration\">Registration</a> | <a href=\"#DiffusionQC\">Diffusion QC & Tensor</a> | <B>Crossing Fibers & Tracts</B> <BR><BR>" >> $reporthtml

		DiffRes=`${FSLDIR}/bin/fslval $StudyFolder/${Subject}/T1w/Diffusion/data pixdim1`
		DiffRes=`printf "%0.2f" ${DiffRes}`
		${FSLDIR}/bin/flirt -in $StudyFolder/$Subject/T1w/wmparc.nii.gz -ref $StudyFolder/${Subject}/T1w/Diffusion/nodif_brain_mask -applyisoxfm ${DiffRes} -o $StudyFolder/$Subject/T1w/wmparc_${DiffRes}.nii.gz -interp nearestneighbour
		${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/T1w/wmparc_${DiffRes}.nii.gz -uthr 2 -thr 2 -bin -mul 39 -add $StudyFolder/$Subject/T1w/wmparc_${DiffRes}.nii.gz -uthr 41 -thr 41 -bin  $StudyFolder/$Subject/T1w/wmparc_${DiffRes}_wm.nii.gz

		v1=`fslstats $StudyFolder/$Subject/T1w/wmparc_${DiffRes}_wm.nii.gz -V | awk '{printf "%f",$1}'`; 
		for j in 1 2 3; do
			${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/T1w/Diffusion.bedpostX/mean_f${j}samples -thr 0.05 -mas $StudyFolder/$Subject/T1w/wmparc_${DiffRes}_wm.nii.gz -bin $StudyFolder/$Subject/T1w/Diffusion.bedpostX/mean_f${j}samples_thr0.05_wm_mask;
			v2=`fslstats $StudyFolder/$Subject/T1w/Diffusion.bedpostX/mean_f${j}samples_thr0.05_wm_mask -V | awk '{printf "%f",$1}'`; 
			cfr=`echo "${v2}/${v1}*100" | bc -l | awk '{printf "%0.2f", $1}'`;
			echo -e "Fiber_${j}_ratio(%)\t${cfr}" >> $OutputFolder/Diffusion/TractographyQC.tsv
		done

		for j in 1 2 3; do
			if [ "$(fslstats $StudyFolder/$Subject/T1w/Diffusion.bedpostX/mean_f${j}samples_thr0.05_wm_mask -V | awk '{print $1}')" != "0" ] ; then
				k=`fslstats $StudyFolder/$Subject/T1w/Diffusion.bedpostX/dyads${j}_dispersion -k $StudyFolder/$Subject/T1w/Diffusion.bedpostX/mean_f${j}samples_thr0.05_wm_mask -m | awk '{printf "%f",$1}'`; 
				D=`perl -E 'use Math::Trig; 'pi'; say acos(1-'$k')*180/pi' | awk '{printf "%0.2f",$1}'`;
				echo -e "Fiber_${j}_uncertainty(degree)\t$D" >> $OutputFolder/Diffusion/TractographyQC.tsv
			else
				echo -e "Fiber_${j}_uncertainty(degree)\tNaN" >> $OutputFolder/Diffusion/TractographyQC.tsv
			fi
		done
		cat $OutputFolder/Diffusion/TractographyQC.tsv | tsv2html >> $reporthtml

		if [ -e $TemplateFolder/scenes/TEMPLATE_TractographyQC.scene ] ; then
			# For crearing Tractography template QC scene 
			# cat TractographyQC.scene | grep Trajectory_1.70 | sed -e 's/Trajectory_1.70/Trajectory_DPIXDIM/g' > TEMPLATE_TractographyQC.scene
			dpixdim=$(fslval $OutputFolder/Diffusion/../../T1w/Diffusion/data.nii.gz pixdim1 | awk '{printf "%1.2f",$1}')
			cat $TemplateFolder/scenes/TEMPLATE_TractographyQC.scene | sed -e 's/Trajectory_DPIXDIM/Trajectory_'$dpixdim'/g' >  $OutputFolder/Diffusion/TractographyQC.scene
			for i in $(seq 1 5); do
				$CARET7DIR/wb_command -show-scene $OutputFolder/Diffusion/TractographyQC.scene $i $reportdir/TractographyQC_${i}.png 3800 1300 > /dev/null 2>&1
			done
		
			echo "<BR><I>Fiber Trajectory and Tracts </I><BR>"  >> $reporthtml
			echo "Check that the fiber trajectory is well aligned to the known tracts of callosal commissural tract at corpus callosum (#1), corticofugal tract at poterior internal capsule (#2) and SLF I-III in the subcortical white matter (#3-#5). Estimated fibers are shown in RGB color in XYZ direction at each voxel with a spatial resolution of diffusion MRI. <BR>" >> $reporthtml
			size=($(identify -format '%w %h' $reportdir/TractographyQC_1.png))
			rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$2*1900/$1}'))
			dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
			echo "#1. Corpus callosum<BR>" >> $reporthtml
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/TractographyQC_1.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
			echo "#2. Posterior internal capsule<BR>" >> $reporthtml
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/TractographyQC_2.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
			echo "#3. SLF I<BR>" >> $reporthtml
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/TractographyQC_3.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
			echo "#4. SLF II<BR>" >> $reporthtml
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/TractographyQC_4.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
			echo "#5. SLF III<BR>" >> $reporthtml
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/TractographyQC_5.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

			echo "The above images can be closely viewed by running the following command:  <BR>"  >> $reporthtml
			echo "<div style=\"background: ghostwhite; font-size: 12px; padding: 12px;; border: 1px solid lightgray; margin: 1px;\"<p><code> $ wb_view $Subject/QC/Diffusion/TractographyQC.scene </code></p></div><BR>" >> $reporthtml
		fi
	fi

	echo "<BR><BR><BR><BR><BR><BR><BR><BR></BODY></HTML>" >>  $reporthtml

fi
}

############################################################
# QC for ICA-FIX
############################################################

ICAFIXQC () {

if [[ $ICAFIX = ON ]] ; then

	logMsg "Creating ICA-FIX report: $Subject"
	
	ICAFIXrfmrilist=$(for i in $StudyFolder/$Subject/MNINonLinear/Results/*/*.ica/filtered_func_data.ica/melodic_oIC.nii.gz; do basename $(dirname $(echo ${i%%.ica*})); done)
	ICAFIXrfmrilist=$(for i in  $ICAFIXrfmrilist; do if [ -e $StudyFolder/$Subject/MNINonLinear/Results/$i/${i}_hp*.ica/filtered_func_data.ica/melodic_oIC.dscalar.nii ] ; then echo $i; fi; done)

for rfmri in $ICAFIXrfmrilist ; do

	WD=$StudyFolder/$Subject/MNINonLinear/Results/${rfmri}
	hps=$(for i in ${WD}/${rfmri}_hp*.ica; do j=${i##*/}; k=${j##*_hp}; hp=${k%%.ica}; echo $hp; done)
    for hp in $hps; do


	logMsg "Creating report for ${rfmri}_hp${hp}.ica"
	reportdir=$StudyFolder/$Subject/QC/ICA-FIX/${rfmri}_hp${hp}.ica/report
	reporthtml=${reportdir}/0000index.html
	if [ -e $reportdir ] ; then rm -rf $reportdir ;fi
	mkdir -p $reportdir
	touch $reporthtml
	
cat <<EOF > $reporthtml
<HTML>
 <HEAD>
   <link REL="stylesheet" TYPE="text/css" href="../../../.files/fsl.css">
   <TITLE>HCP pipeline ICA-FIX REPORT</TITLE>
   <link rel="icon" type="image/x-icon" href="../../../.files/favicon.ico">
   <style type="text/css">
    .button {
      display       : inline-block;
      border-radius : 20%;     
      font-size     : 8pt;    
      text-align    : center; 
      cursor        : pointer;
      padding       : 6px;
      background    : #ccc;
      color         : #000000;
      line-height   : 1em;    
      transition    : .3s;
      border: solid 1px;
      text-decoration: none;
      margin: 0px 10px;
    }
 </style>
 <link href="../../../.files/lightbox.css" rel=stylesheet> 
 <script src="../../../.files/jquery.min.js"></script>
 <script src="../../../.files/lightbox.min.js" type="text/javascript"></script>
 <link type="text/css" href="../../../.files/magnifier.css" rel="stylesheet">
 <script type="text/javascript" src="../../../.files/magnifier.js"></script>
 </HEAD>
 <BODY BGCOLOR="#FFFFFF" TEXT="#151515">
  <hr>
  <img src="../../../.files/BCIL_1.png" style="border:none; width:150px;height:60px;float:right;">
  <img src="../../../.files/bmb.png" style="border:none; width:180px;height:50px;float:right;">
  <img src="../../../.files/hcplogo1.jpg" style="border:none; width:150px;height:50px;float:right;">
  <img src="../../../.files/fsl-logo-x2.png" style="border:none; width:80px;height:50px;float:right;">
  <img src="../../../.files/freesurfer.png" style="border:none; width:100px;height:50px;float:right;">
  <B>HCP pipeline ICA-FIX REPORT</B><BR>
  <FONT size=1>Version 0.1 &copy;2006-2021</FONT><BR><BR>
  <Font size=2>Output directory: ${StudyFolder}/${Subject}/QC/ICA-FIX/${rfmri}_hp${hp}.ica/report</FONT><BR><hr>
EOF

	dim=$(fslval $WD/${rfmri}_hp${hp}.ica/filtered_func_data.ica/melodic_oIC.nii.gz dim4)
	logMsg Dim=$dim
	${CARET7DIR}/wb_command -file-information $WD/${rfmri}_hp${hp}.ica/filtered_func_data.ica/melodic_oIC.dscalar.nii -only-map-names > $reportdir/componentslist.txt

	# Create png files
	#command=$reportdir/CreatePNGs.sh
	#if [ -e $command ] ; then rm $command;fi
	
	#for i in $(seq 1 $dim); do

	#	curpg=$(zeropad $i 4)
			
	#	echo "${CARET7DIR}/wb_command -show-scene $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene 1 $reportdir/${curpg}a.png 3000 1116 -set-map-yoke I $i; \
	#	${CARET7DIR}/wb_command -show-scene $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene 2 $reportdir/${curpg}c.png 3000 1116 -set-map-yoke I $i; \
	#	${CARET7DIR}/wb_command -show-scene $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene 3 $reportdir/${curpg}s.png 3000 1116 -set-map-yoke I $i; \
	#	convert $reportdir/${curpg}a.png -quality 85 $reportdir/${curpg}a.jpg; \
	#	convert $reportdir/${curpg}c.png -quality 85 $reportdir/${curpg}c.jpg; \
	#	convert $reportdir/${curpg}s.png -quality 85 $reportdir/${curpg}s.jpg; \
	#	rm $reportdir/${curpg}[a,c,s].png" >> $command

	#done
	#logMsg "Creating jpg files"
	#chmod +x $command
	#jid=`fsl_sub -l $StudyFolder/$Subject/logs -q short.q -N -t $command`

	# Create report html
	for i in $(seq 1 $dim); do

		curpg=$(zeropad $i 4)
		logMsg "Creating report html for IC=${curpg} "

		${CARET7DIR}/wb_command -show-scene $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene 1 $reportdir/${curpg}a.png 3000 1116 -set-map-yoke I $i > /dev/null 2>&1;
		${CARET7DIR}/wb_command -show-scene $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene 2 $reportdir/${curpg}c.png 3000 1116 -set-map-yoke I $i > /dev/null 2>&1; 
		${CARET7DIR}/wb_command -show-scene $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene 3 $reportdir/${curpg}s.png 3000 1116 -set-map-yoke I $i > /dev/null 2>&1; 
		convert $reportdir/${curpg}a.png -quality 85 $reportdir/${curpg}a.jpg; 
		convert $reportdir/${curpg}c.png -quality 85 $reportdir/${curpg}c.jpg; 
		convert $reportdir/${curpg}s.png -quality 85 $reportdir/${curpg}s.jpg; 
		rm $reportdir/${curpg}[a,c,s].png

		if [ $i = 1 ] ; then
			prepg=$(zeropad $i 4)
		else
			prepg=$(zeropad $((i-1)) 4)
		fi
		if [ $i = $dim ] ; then
			nxtpg=$(zeropad $i 4)
		else
			nxtpg=$(zeropad $((i+1)) 4)
		fi

		for slice in a c s; do

			cp $reporthtml $reportdir/${curpg}${slice}.html

cat <<EOF >> $reportdir/${curpg}${slice}.html
  <FORM NAME="form1">
  <center>
  <a href="${prepg}${slice}.html" class="button"><</a>
  <SELECT NAME="select1" onChange="if(document.form1.select1.value){location.href=document.form1.select1.value;}">
  <option value="#">Select components</option>
EOF

  			cat $reportdir/componentslist.txt | awk '{if(NR=='$i') flag="selected"; else flag="" ;printf "<option value=\"%04d%s.html\" %s>%s %s</option>\n",$1,"'"$slice"'",flag,$1,$2}' >> $reportdir/${curpg}${slice}.html

cat <<EOF >> $reportdir/${curpg}${slice}.html
  </SELECT>
  <a href="${nxtpg}${slice}.html" class="button">></a>
  <a href="${curpg}a.html" class="button">Axi</a>
  <a href="${curpg}c.html" class="button">Cor</a>
  <a href="${curpg}s.html" class="button">Sag</a>
  </center>
  </FORM>
<center>
<div class="magnifier" style="width: 1800px; height: 670px">
  <div class="maglens" style="width:240px; height:150px">
    <img src="${curpg}${slice}.jpg" class="maglarge" style="width: 3000px height: 1116px" />
  </div>
</div>
</center>
<Font size=2>Note that IC components (in RY-BC-BL color) are overlaid on sulc (in gray) and very-inflated surfaces (left) and on bias-corrected T1w volume sections (right upper, in gray) with a opacity of 0.8. Volume sections also show white surfaces in lime and pial surfaces in blue line overlaid on IC components. If you found incorrect classification, please list ID of those components either in ReclassifyAsNoise.txt or ReclassifyAsSignal.txt in $WD, and run ReApplyFixPipeline.sh or ReApplyFixMultiRunPipeline.sh </FONT>
<BR><BR>
</BODY>
</HTML>
EOF

		done
	done

cat <<EOF >> $reporthtml
  <FORM NAME="form1">
  <center>
  <SELECT NAME="select1" onChange="if(document.form1.select1.value){location.href=document.form1.select1.value;}">
  <option value="#">Select components</option>
EOF

	cat $reportdir/componentslist.txt | awk '{printf "<option value=\"%04da.html\" >%s %s</option>\n",$1,$1,$2}' >> $reporthtml

cat <<EOF >> $reporthtml
  </SELECT>
  </center>
  </FORM>
</BODY>
</HTML>
EOF
	rm $reportdir/componentslist.txt

	${CARET7DIR}/wb_command -scene-file-relocate $WD/${Subject}_${rfmri}_hp${hp}_ICA_Classification_singlescreen.scene $StudyFolder/$Subject/QC/ICA-FIX/${rfmri}_hp${hp}_QC.scene

    done
done

logMsg "Finished creating ICA-FIX reports!"

fi
}

############################################################
# QC for Functional MRI
############################################################

FuncQC () {

if [[ $Func = ON && $(ls $StudyFolder/$Subject/MNINonLinear/Results/*/*.ica/filtered_func_data.ica/melodic_oIC.nii.gz 2> /dev/null) = "" ]] ; then
 	echo "WARNING: not found ICA-FIX results.. skip QC for function" 
 	return

elif [[ $Func = ON && $(ls $StudyFolder/$Subject/MNINonLinear/Results/*/*.ica/filtered_func_data.ica/melodic_oIC.nii.gz 2> /dev/null) != "" ]] ; then

	logMsg "Creating Functional QC: $Subject"
	
	if [ -e $OutputFolder/Function ] ; then rm -rf $OutputFolder/Function ;fi
	mkdir -p $OutputFolder/Function/report

	WD=$OutputFolder/Function
	reportdir=${WD}/report
	reporthtml=${WD}/report.html
	mkdir -p $reportdir
	touch $reporthtml
	echo "<HTML><HEAD><link REL=\"stylesheet\" TYPE=\"text/css\" href=\"../.files/fsl.css\"><TITLE>HCPPIPE QC REPORT</TITLE><link rel="icon" type="image/x-icon" href="../.files/favicon.ico"> <link href="../.files/lightbox.css" rel=stylesheet>
 <script src="../.files/jquery.min.js"></script><script src="../.files/lightbox.min.js" type="text/javascript"></script><link type="text/css" href="../.files/magnifier.css" rel="stylesheet"><script type="text/javascript" src="../.files/magnifier.js"></script></HEAD><BODY BGCOLOR=\"#FFFFFF\" TEXT=\"#151515\">" >> $reporthtml

	# Inputs
	echo "<a name=\"Inputs\"><div id=\"Inputs\"></div></a>" >> $reporthtml
	echo "<hr><B><span style=\"color:gray\">Function</span></B> - | <B>Inputs</B> " >> $reporthtml
	for i in $Tasklist $Fmriconcatlist; do 
		echo "| <a href=\"#${i}\">${i}</a> " >> $reporthtml
	done
	echo "<BR><BR>" >> $reporthtml

	if [[ -z ${TopupDwellTime+x} && -n $DwellTime ]] ; then 
		TopupDwellTime="$DwellTime"
	fi
				
	if [ ! -z "$T1wInputImages" ] ; then # imported imputs data from hcppipe_conf.txt
		echo "<I>Inputs to preprocessing</I><BR>" >> $reporthtml
		echo -e "Modality \t Filename\tEchoSpacing\tPhaseDir\tGradientCoil" > $reportdir/inputs_fMRI.tsv
		echo -e "fMRI \t ${Tasklist} \t${DwellTime:-NONE}\t${PhaseEncodinglist:-NONE}\t${Gradient:-NONE}" >> $reportdir/inputs_fMRI.tsv
		echo -e "fMRIRef \t $Taskreflist\t${DwellTime:-NONE}\t${PhaseEncodinglist:-NONE}\t${Gradient:-NONE}" >> $reportdir/inputs_fMRI.tsv
		cat $reportdir/inputs_fMRI.tsv | tsv2html >> $reporthtml
		echo "PhaseDir label: PA=y, AP=y-, RL=x, LR=x-<BR><BR>" >> $reporthtml
		echo -e "Modality\tFilename\tPhaseEchoSpacing\tPhaseEncodingDir\tGradientCoil" > $reportdir/inputs_topup.tsv
		echo -e "TopupPositive\t$TopupPositive\t${TopupDwellTime}\tPositive\t${Gradient}" >> $reportdir/inputs_topup.tsv	
		echo -e "TopupNegative\t$TopupNegative\t${TopupDwellTime}\tNegative\t${Gradient}" >> $reportdir/inputs_topup.tsv	
		cat $reportdir/inputs_topup.tsv | tsv2html >> $reporthtml			
		echo "<BR>" >> $reporthtml
	fi

	if [ -e $StudyFolder/$Subject/RawData/Seriesinfo.csv ] ; then
		echo "<I>Scanning parameters for input volumes</I><BR>" >> $reporthtml
		echo -e "Filename\tSeriesNum\tProtocol\tTR[ms]\tTE[ms]\tTI[ms]\tFA[deg]\tMatrix\tPixelSize[mm]\tSliceThickness[mm]\tPreScanNorm\tDwelltimeRead[sec]\tDwelltimePhase[sec]\tReadDir\tPhaseDir\tSliceDir\tTxAmp[V]\tParallelFactor\tMultiBandFactor" > $reportdir/scaninfo.tsv
		for i in $Tasklist $Taskreflist $TopupPositive $TopupNegative ; do

		  if [ "$(imtest $StudyFolder/$Subject/RawData/$i)" = 1 ] ; then
			if [ "$(imtest $StudyFolder/$Subject/RawData/$(remove_ext $i).orig )" = 1 ] ; then
				link=$(ls -loh --time-style=iso $(imglob -extension $StudyFolder/$Subject/RawData/$(remove_ext $i).orig) | awk '{print $NF}')				
			else
				link=$(ls -loh --time-style=iso $(imglob -extension $StudyFolder/$Subject/RawData/$i) | awk '{print $NF}')	
			fi
			if [ ! -z "$link" ] ; then
				scannum=$(echo $(basename $link | cut -d '_' -f 1))
				logMsg "Scan Num: $scannum $i -> $link"				
				if [[ ! -z $(cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {print $15}' | grep NORM) ]] ; then
					PreScanNorm=ON
				else
					PreScanNorm=OFF
				fi
				#echo $PreScanNorm
				pixsize=($(printf "%0.2f " $(cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {print $12}')))
				pixsize="${pixsize[0]}x${pixsize[1]}"
				cat $StudyFolder/$Subject/RawData/Seriesinfo.csv | awk 'BEGIN{FS=","} $1 == '$scannum' {printf "%s\t%d\t%s\t%0.0f\t%0.2f\t%0.0f\t%d\t%s\t%s\t%0.2f\t%s\t%0.7f\t%0.7f\t%s\t%s\t%s\t%0.1f\t%d\t%d\n","'$i'",$1,$4,$7,$8,$9,$10,$11,"'${pixsize}'",$13,"'$PreScanNorm'",$16,$17,$18,$19,$20,$22,$23,$24}' >> $reportdir/scaninfo.tsv
			else
				echo -e "$i\tNo link to\tprotocol.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t" >> $reportdir/scaninfo.tsv
			fi
		  else
		  	echo "WARNING: Cannnot find $StudyFolder/$Subject/RawData/$i"
		  fi
		done
		cat $reportdir/scaninfo.tsv | tsv2html >> $reporthtml
		echo "<BR>" >> $reporthtml
	fi

	# investigate high pass
	files=""
	for fmriname in $Fmriconcatlist ; do
		files+="$(ls $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp*_clean.nii.gz) "
	done
	nfiles=$(echo $files | wc -w)
	if [ $nfiles = 0 ] ; then 
			echo "ERROR: no high pass cleaned data exits!";
			exit 1;
	else		
			hps=$(for file in $files; do j=${file##*/}; k=${j##*_hp}; hp=${k%%_clean.nii.gz}; echo $hp; done)
			logMsg "High pass filter: $hps"
			if [[ $(echo $hps | wc -w) -gt 1 ]] ; then
				echo "ERROR: multiple high pass cleaned data exits!";
				exit 1;
			else
				hp=$hps
			fi
	fi						

	# For fmris	
	
	for fmriname in $Tasklist ; do

		logMsg "Creating report for fmri: $fmriname"
		echo "<a name=\"$fmriname\"><div id=\"$fmriname\"></div></a>" >> $reporthtml
		echo "<hr><B><span style=\"color:gray\">Function</span></B> - | <a href=\"#Inputs\">Inputs</a>" >> $reporthtml
		for i in $Tasklist $Fmriconcatlist; do
			if [[ $i == $fmriname ]] ; then
				echo "| <B>$i</B> " >> $reporthtml
			else
				echo "| <a href=\"#${i}\">${i}</a> " >> $reporthtml
			fi
		done
		echo "<BR><BR>" >> $reporthtml

		if [ ! -e $StudyFolder/$Subject/${fmriname}/Movement_Regressors.txt ] ; then
			break;
		fi
		WDfMRI=${WD}/${fmriname}
		ReportDirfMRI=${reportdir}/${fmriname}
		
		mkdir -p $ReportDirfMRI
		mkdir -p ${WDfMRI}
		cp $StudyFolder/$Subject/${fmriname}/Movement_Regressors.txt ${WDfMRI}/Movement_Regressors.txt
		cp $StudyFolder/$Subject/${fmriname}/Movement_Regressors_dt.txt ${WDfMRI}/Movement_Regressors_dt.txt
		cp $StudyFolder/$Subject/${fmriname}/Movement_AbsoluteRMS.txt ${WDfMRI}/Movement_AbsoluteRMS.txt
		cp $StudyFolder/$Subject/${fmriname}/Movement_RelativeRMS.txt ${WDfMRI}/Movement_RelativeRMS.txt
		cp $StudyFolder/$Subject/${fmriname}/Movement_AbsoluteRMS_mean.txt ${WDfMRI}/Movement_AbsoluteRMS_mean.txt
		cp $StudyFolder/$Subject/${fmriname}/Movement_RelativeRMS_mean.txt ${WDfMRI}/Movement_RelativeRMS_mean.txt
		cp $StudyFolder/$Subject/${fmriname}/MotionCorrection/${fmriname}_mc.ecclog ${WDfMRI}/${fmriname}_mc.ecclog

		if [[ $(cat ${WDfMRI}/${fmriname}_mc.ecclog | grep "mat/MAT_") != "" ]] ; then
			echo "<I>Motion correction with MCFLIRT and ICA-FIX clean</I><BR><BR>"  >> $reporthtml
		else
			echo "<I>Motion correction with FLIRT and ICA-FIX clean</I><BR><BR>"  >> $reporthtml
		fi

		# For motion, FD, DVARS and greyplots		 
		logMsg "Creating plots of motion, greyordinates and DVARS: $fmriname"
		matlab -nodesktop -nodisplay -r "addpath $BCILDIR/bin $DVARSDIR $DVARSDIR/mis $HCPPIPEDIR/global/matlab; bcil_motiongreyplot('${WDfMRI}/Movement_Regressors.txt','$StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas.dtseries.nii','$StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_hp${hp}_clean.dtseries.nii','wb_command','$OutputFolder/Function/report/${fmriname}/${fmriname}_motiongreyplot.png');exit"
		size=($(identify -format '%w %h' $OutputFolder/Function/report/${fmriname}/${fmriname}_motiongreyplot.png))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${fmriname}/${fmriname}_motiongreyplot.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

		echo "<I>Estimated movement</I><BR>"  >> $reporthtml
		MoveAbsRMS=$(cat ${WDfMRI}/Movement_AbsoluteRMS_mean.txt);
		MoveRelRMS=$(cat ${WDfMRI}/Movement_RelativeRMS_mean.txt);
		FDmedian=$(cat ${WDfMRI}/Movement_Regressors_FD_stats.txt | grep Q2 | awk '{print $2}');
		echo -e "Absolute RMS (mean)\tRelative RMS (mean)\tFramewise displacement [mm] (median)" > ${WDfMRI}/Movement_stats.tsv
		echo -e "$MoveAbsRMS\t$MoveRelRMS\t$FDmedian" >> ${WDfMRI}/Movement_stats.tsv
		cat ${WDfMRI}/Movement_stats.tsv | tsv2html >> $reporthtml
		echo "</table><BR>"  >> $reporthtml 

		cp $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_DSE_stats.csv $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_hp${hp}_clean_DSE_stats.csv ${WDfMRI}/
		UncDVARSOutlier=$(cat  $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_DVARS_outliers.txt  | awk '{sum+=$1} END {printf "%1.1f\n", sum/NR*100}');
		ClnDVARSOutlier=$(cat  $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_hp${hp}_clean_DVARS_outliers.txt  | awk '{sum+=$1} END {printf "%1.1f\n", sum/NR*100}');
		UncDvarSvarDivergence=$(cat ${WDfMRI}/${fmriname}_Atlas_DSE_stats.csv | awk -F, 'NR==3||NR==4 {sum+=($4-1)^2;} END{printf "%.5f\n", sqrt(sum);}');
		ClnDvarSvarDivergence=$(cat ${WDfMRI}/${fmriname}_Atlas_hp${hp}_clean_DSE_stats.csv | awk -F, 'NR==3||NR==4 {sum+=($4-1)^2;} END{printf "%.5f\n", sqrt(sum);}');
		UncACcoeffMedian=$(cat $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_ACcoeff_median.txt);
		ClnACcoeffMedian=$(cat $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_Atlas_hp${hp}_clean_ACcoeff_median.txt);
		echo -e "Data\t%Significant outlier volumes\tDvar-Svar divergence\tAutocorrelation coefficinet (median)" > ${WDfMRI}/ICA-FIX_stats.tsv
		echo -e "motion and distortion corrected\t$UncDVARSOutlier\t$UncDvarSvarDivergence\t$UncACcoeffMedian" >>  ${WDfMRI}/ICA-FIX_stats.tsv
		echo -e "ICA-FIX cleaned\t$ClnDVARSOutlier\t$ClnDvarSvarDivergence\t$ClnACcoeffMedian" >>  ${WDfMRI}/ICA-FIX_stats.tsv
		echo "<I>ICA-FIX QC</I><BR>" >> $reporthtml 
		cat ${WDfMRI}/ICA-FIX_stats.tsv | tsv2html >> $reporthtml 
		echo "<BR><BR>"  >> $reporthtml
		
		# QC for distortion correction
		logMsg "QC for distortion correction: $fmriname"
		DistCorDir=$StudyFolder/$Subject/${fmriname}/DistortionCorrectionAndEPIToT1wReg_FLIRTBBRAndFreeSurferBBRbased
		FieldMapDir=$DistCorDir/FieldMap
		echo "<I>Distortion correction</I><BR>" >> $reporthtml 	

		if [ -e ${FieldMapDir}/acqparams.txt ] ; then # SE fieldmap
			FMtype="SE field"
			if [[ $(cat ${FieldMapDir}/acqparams.txt | awk '{x = $1; S += x*x; N++;} END {print sqrt(S/N)}') != 0 ]] ; then
				PhaseDir=x
			elif [[ $(cat ${FieldMapDir}/acqparams.txt | awk '{x = $2; S += x*x; N++;} END {print sqrt(S/N)}') != 0 ]] ; then
				PhaseDir=y
			else
				PhaseDir=Unknown
			fi
			if [ -e ${FieldMapDir}/SBRef2PhaseOne_gdc.nii.gz ] ; then
				Polality="-"
			else
				Polality="+"
			fi
			echo "Fieldmap type: $FMtype<BR>Fieldmap phase encoding axis: <B>$PhaseDir</B><BR>fMRI phase encoding direction: <B>${Polality}${PhaseDir}</B><BR><BR>" >> $reporthtml
			echo "<I> Distorted and undistorted SE field volumes.</I><BR>Check that the input SE fieldmap is correctly used and properly analyzed. Confirm that SE filedmap are a pair of inputs distorted in opposed phased encoding direction (left) and corrected for distortion and signals modulated by Jacobian (right).<BR>" >> $reporthtml
			# Magnitude PhaseOne vs PhaseTwo to check registration & distortion correction quality
			for dc in _gdc _gdc_dc_jac ; do 
				${FSLDIR}/bin/fslroi ${FieldMapDir}/PhaseOne${dc}.nii.gz ${WDfMRI}/PhaseOne${dc}_vol0.nii.gz 0 1
				${FSLDIR}/bin/fslroi ${FieldMapDir}/PhaseTwo${dc}.nii.gz ${WDfMRI}/PhaseTwo${dc}_vol0.nii.gz 0 1
				${FSLDIR}/bin/flirt -in ${WDfMRI}/PhaseOne${dc}_vol0.nii.gz -ref $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -applyxfm -init ${FieldMapDir}/../fMRI2str.mat -o ${WDfMRI}/PhaseOne${dc}_hires.nii.gz 
				${FSLDIR}/bin/flirt -in ${WDfMRI}/PhaseTwo${dc}_vol0.nii.gz -ref $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -applyxfm -init ${FieldMapDir}/../fMRI2str.mat -o ${WDfMRI}/PhaseTwo${dc}_hires.nii.gz 
				${FSLDIR}/bin/slicer ${WDfMRI}/PhaseOne${dc}_hires.nii.gz $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -s 2 -e .05 -a ${WDfMRI}/PhaseOne${dc}_hires.png
				${FSLDIR}/bin/slicer ${WDfMRI}/PhaseTwo${dc}_hires.nii.gz $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -s 2 -e .05 -a ${WDfMRI}/PhaseTwo${dc}_hires.png

				convert -loop 0 -delay 100 ${WDfMRI}/PhaseOne${dc}_hires.png ${WDfMRI}/PhaseTwo${dc}_hires.png ${ReportDirfMRI}/PhaseOnevsTwo${dc}.gif
				rm ${WDfMRI}/PhaseOne${dc}_hires.png ${WDfMRI}/PhaseTwo${dc}_hires.png
				imrm ${WDfMRI}/PhaseOne${dc}_vol0.nii.gz ${WDfMRI}/PhaseTwo${dc}_vol0.nii.gz ${WDfMRI}/PhaseOne${dc}_hires.nii.gz ${WDfMRI}/PhaseTwo${dc}_hires.nii.gz
				if [ $dc = _gdc_dc_jac ] ; then
					fslmaths ${FieldMapDir}/PhaseOne${dc}.nii.gz -sub ${FieldMapDir}/PhaseTwo${dc}.nii.gz -abs ${WDfMRI}/PhaseDiffAbs.nii.gz
				fi				
			done

			gifmergeh ${ReportDirfMRI}/PhaseOnevsTwo_gdc.gif ${ReportDirfMRI}/PhaseOnevsTwo_gdc_dc_jac.gif ${ReportDirfMRI}/PhaseOnevsTwo_gdc_merge.gif
			rm ${ReportDirfMRI}/PhaseOnevsTwo_gdc.gif ${ReportDirfMRI}/PhaseOnevsTwo_gdc_dc_jac.gif 
			size=($(identify -format '%w %h' ${ReportDirfMRI}/PhaseOnevsTwo_gdc_merge.gif))
			rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
			dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${fmriname}/PhaseOnevsTwo_gdc_merge.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
			
			# B0 fieldmap and magnitude
			$FSLDIR/bin/applywarp -i ${FieldMapDir}/TopupField.nii.gz -r $DistCorDir/T1w_acpc_dc_restore_brain.nii.gz --premat=$DistCorDir/fMRI2str.mat -o $DistCorDir/FieldMap2T1w_acpc.nii.gz
			$FSLDIR/bin/fslmaths $DistCorDir/FieldMap2T1w_acpc -thr 0 $DistCorDir/FieldMap2T1w_acpc_p
			$FSLDIR/bin/fslmaths $DistCorDir/FieldMap2T1w_acpc -uthr 0 -mul -1 $DistCorDir/FieldMap2T1w_acpc_m			
			$FSLDIR/bin/overlay 1 0 $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -a $DistCorDir/FieldMap2T1w_acpc_p .0001 500 $DistCorDir/FieldMap2T1w_acpc_m .0001 500 $DistCorDir/FieldMap2T1w_acpc_overlay.nii.gz
			$FSLDIR/bin/slicer $DistCorDir/FieldMap2T1w_acpc_overlay.nii.gz -a ${reportdir}/FieldMap2T1w_acpc_overlay.png			
			$FSLDIR/bin/applywarp -i ${FieldMapDir}/Magnitude.nii.gz -r $DistCorDir/T1w_acpc_dc_restore_brain.nii.gz --premat=$DistCorDir/fMRI2str.mat -o $DistCorDir/Mag2T1w_acpc.nii.gz
			${FSLDIR}/bin/slicer $DistCorDir/Mag2T1w_acpc.nii.gz $StudyFolder/$Subject/T1w/T1w_acpc.nii.gz -a ${reportdir}/MagT1w_acpc.png
			$FSLDIR/bin/pngappend ${reportdir}/FieldMap2T1w_acpc_overlay.png + ${reportdir}/MagT1w_acpc.png ${reportdir}/FieldMapMag2T1w_acpc_overlay.png
			rm ${reportdir}/FieldMap2T1w_acpc_overlay.png ${reportdir}/MagT1w_acpc.png
			echo "<I>B0 fieldmap and magnitude</I><BR>" >> $reporthtml
			echo "Check that fieldmap (red/blue color in left panel) is high in inferior frontal & temporal areas but not very high in other areas. The IQR of fieldmap is useally less than 200 rad/sec. Check that the magnitude is well reconstructed and aligned with T1w_acpc (red contour, right panel). <BR>" >> $reporthtml
			size=($(identify -format '%w %h' ${reportdir}/FieldMapMag2T1w_acpc_overlay.png))
			rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
			dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/FieldMapMag2T1w_acpc_overlay.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div>" >> $reporthtml
			cp $FSLDIR/etc/luts/ramp*.gif ${reportdir}/
			echo "-500<img src=\"./report/ramp2.gif\"><img src=\"./report/ramp.gif\">500 <BR>" >> $reporthtml
			echo -e "${FMtype} B0 fieldmap [rad/sec] in brain area\t" > ${WDfMRI}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/TopupField.nii.gz -k ${FieldMapDir}/Magnitude_brain -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ1\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> ${WDfMRI}/Fieldmap_stats.tsv
			${CARET7DIR}/wb_command -volume-gradient ${FieldMapDir}/TopupField.nii.gz ${FieldMapDir}/TopupField_grad.nii.gz
			echo -e "B0 fieldmap gradient in brain area\t" >> ${WDfMRI}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/TopupField_grad.nii.gz -k ${FieldMapDir}/Magnitude_brain -m | awk '{printf "Gradient (mean)\t%1.2f\n",$1}' >>  ${WDfMRI}/Fieldmap_stats.tsv	
			echo -e "Phase diff abs in brain area\t" >> ${WDfMRI}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${WDfMRI}/PhaseDiffAbs -k ${FieldMapDir}/Magnitude_brain -m | awk '{printf "PhaseDiffAbs (mean)\t%1.2f\n",$1}' >> ${WDfMRI}/Fieldmap_stats.tsv
			
		else # GE fieldmap
			FMtype="GE field"
			echo "TO DO"	>> $reporthtml
			echo -e "${FMtype} B0 fieldmap [rad/sec] in brain area\t" > ${WDfMRI}/Fieldmap_stats.tsv
		${FSLDIR}/bin/fslstats ${FieldMapDir}/FieldMap.nii.gz -k ${FieldMapDir}/Magnitude_brain -p 0 -p 25 -p 50 -p 75 -p 100 | awk '{printf "Min\t%1.2f\nQ1\t%1.2f\nQ2\t%1.2f\nQ3\t%1.2f\nMax\t%1.2f\nIQR\t%1.2f\n",$1,$2,$3,$4,$5,$4-$2}' >> ${WDfMRI}/Fieldmap_stats.tsv
			${CARET7DIR}/wb_command -volume-gradient ${FieldMapDir}/FieldMap.nii.gz ${FieldMapDir}/FieldMap_gradient.nii.gz
			echo -e "B0 fieldmap gradient in brain area\t" >> ${WDfMRI}/Fieldmap_stats.tsv
			${FSLDIR}/bin/fslstats ${FieldMapDir}/FieldMap_gradient.nii.gz -k ${FieldMapDir}/Magnitude_brain -m | awk '{printf "Gradient (mean)\t%1.2f\n",$1}' >> ${WDfMRI}/Fieldmap_stats.tsv

		fi
		cat ${WDfMRI}/Fieldmap_stats.tsv | tsv2html >> $reporthtml
		echo "<BR><BR>"  >> $reporthtml 
		
		# QC for registration
		logMsg "QC for registration: $fmriname"
		echo "<I>Registration</I><BR><BR>" >> $reporthtml 	
		echo "<I>${fmriname} Ref vs T1w_acpc</I><BR>"  >> $reporthtml
		echo "Check that distortion-corrected Ref image aligns well with the T1w_acpc (left, <B>sqrt(T1w*EPI)</B>; right, <B>Scout2T1w</B> w/ red contours of T1w_acpc_restore_brain).<BR>"  >> $reporthtml
		${FSLDIR}/bin/slicer $StudyFolder/$Subject/${fmriname}/T1wMulEPI $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore_brain -s 2 -e 0.05 -a ${ReportDirfMRI}/${fmriname}+finalmask.png
		${FSLDIR}/bin/slicer $StudyFolder/$Subject/${fmriname}/Scout2T1w $StudyFolder/$Subject/T1w/T1w_acpc_dc_restore_brain -s 2 -e 0.05 -a ${ReportDirfMRI}/${fmriname}+T1w_acpc_dc_restore.png
		${FSLDIR}/bin/pngappend ${ReportDirfMRI}/${fmriname}+finalmask.png + ${ReportDirfMRI}/${fmriname}+T1w_acpc_dc_restore.png ${ReportDirfMRI}/${fmriname}+mask+T1w_acpc_dc_restore.png
		convert ${ReportDirfMRI}/${fmriname}+mask+T1w_acpc_dc_restore.png ${ReportDirfMRI}/${fmriname}+mask+T1w_acpc_dc_restore.gif
		rm ${ReportDirfMRI}/${fmriname}+T1w_acpc_dc_restore.png ${ReportDirfMRI}/${fmriname}+finalmask.png

		size=($(identify -format '%w %h' ${ReportDirfMRI}/${fmriname}+mask+T1w_acpc_dc_restore.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$2*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${fmriname}/${fmriname}+mask+T1w_acpc_dc_restore.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml
				
		# QC for registration between scout and cortical surfaces
		$FSLDIR/bin/applywarp -i $StudyFolder/$Subject/${fmriname}/Scout_gdc.nii.gz -r $StudyFolder/$Subject/T1w/T1w_acpc_dc.nii.gz -w $StudyFolder/$Subject/T1w/xfms/${fmriname}2str.nii.gz -o $StudyFolder/$Subject/${fmriname}/Scout2T1w_nomask.nii.gz		
		cat $TemplateFolder/scenes/TEMPLATE_fMRINameBBRQC.scene | sed s/SubjectID/${Subject}/g | sed s/fMRIName/${fmriname}/g | sed s@StudyFolder@"../../../../"@g   > ${WDfMRI}/${fmriname}BBRQC.scene
		# NOTES: how to create TemplateScene
		# cat rfmri01_RLBBRQC.scene  | sed s/A18031601/SubjectID/g | sed s/rfmri01_RL/fMRIName/g | sed s@"../../../../"@StudyFolder@g  > TEMPLATE_fMRINameBBRQC.scene

		${CARET7DIR}/wb_command -show-scene ${WDfMRI}/${fmriname}BBRQC.scene 1 $OutputFolder/Function/report/${fmriname}/${fmriname}BBRQC.png 3800 1300 > /dev/null 2>&1
		convert $OutputFolder/Function/report/${fmriname}/${fmriname}BBRQC.png ${ReportDirfMRI}//${fmriname}BBRQC.gif
		rm -rf $OutputFolder/Function/report/${fmriname}/${fmriname}BBRQC.png 
		#$StudyFolder/$Subject/${fmriname}/Scout2T1w_nomask.nii.gz ${WDfMRI}/${fmriname}BBRQC.scene
		
		size=($(identify -format '%w %h' ${ReportDirfMRI}/${fmriname}BBRQC.gif))
		rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$2*1900/$1}'))
		dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
		echo "<I>${fmriname}_Ref vs surfaces</I><BR>"  >> $reporthtml
		echo "Check that cortical ribbon of the distortion-corrected ref image aligns well with white and pial surfaces. Subtle misregistration can cause partial voluming effect in the signals of cortical ribbon. It is often useful to closely investigate sagittal (1st row) and axial sections (3rd row) if fMRI's phase-encode is in y-axis, and axial and coronal sections (2nd row) if fMRI's phase-encode is in x-axis. <BR>"  >> $reporthtml
		echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${fmriname}/${fmriname}BBRQC.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

		DistCorDir=$StudyFolder/$Subject/${fmriname}/DistortionCorrectionAndEPIToT1wReg_FLIRTBBRAndFreeSurferBBRbased
		if [ -e $DistCorDir ] ; then
			if [ -e ${DistCorDir}/Scout_gdc_undistorted2T1w_init_fast_wmseg.nii.gz ] ; then # SE field
				WMSEG=${DistCorDir}/Scout_gdc_undistorted2T1w_init_fast_wmseg.nii.gz
			elif [ -e ${DistCorDir}/Scout_gdc_undistorted_fast_wmseg.nii.gz ] ; then # GE field
				WMSEG=${DistCorDir}/Scout_gdc_undistorted_fast_wmseg.nii.gz 
			fi
			echo -e "FSL_BBR_mincost\t$(flirt -in ${DistCorDir}/Scout_gdc_undistorted.nii.gz -ref ${DistCorDir}/T1w_acpc_dc_restore_brain.nii.gz -schedule $FSLDIR/etc/flirtsch/measurecost1.sch -init ${DistCorDir}/Scout_gdc_undistorted2T1w_init.mat -wmseg $WMSEG -cost bbr | head -1 | awk '{print $1}')" > $OutputFolder/Function/${fmriname}/EPI2T1w.mincost.tsv
			if [ -e ${DistCorDir}/EPItoT1w.dat.mincost ] ; then
				echo -e "FreeSurfer_BBR_mincost\t$(cat ${DistCorDir}/EPItoT1w.dat.mincost | awk '{print $1}')" >> $OutputFolder/Function/${fmriname}/EPI2T1w.mincost.tsv
			fi
			cat $OutputFolder/Function/${fmriname}/EPI2T1w.mincost.tsv | tsv2html >> $reporthtml
			echo "<BR><BR>" >> $reporthtml
		fi

		# Uncleaned and cleaned fmri movie
		if [[ $CreateMovie = "ON" ]] ; then 
			${FSLDIR}/bin/fslanimate $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}.nii.gz ${ReportDirfMRI}/${fmriname}.gif
			echo "<I>Mocion and distortion-corrected and noise-cleaned fmri </I><BR>"  >> $reporthtml
			echo "Check that imaging artifacts (including motion-related) in uncleaned data (left) are reasonably removed in the cleaned (right). <BR>" >> $reporthtml
			${FSLDIR}/bin/fslanimate $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp${hp}_clean.nii.gz ${ReportDirfMRI}/${fmriname}_hp${hp}_clean.gif
			gifmergeh ${ReportDirfMRI}/${fmriname}.gif ${ReportDirfMRI}/${fmriname}_hp${hp}_clean.gif ${ReportDirfMRI}/${fmriname}_hp${hp}_merge.gif
			rm ${ReportDirfMRI}/${fmriname}.gif ${ReportDirfMRI}/${fmriname}_hp${hp}_clean.gif
			size=($(identify -format '%w %h' ${ReportDirfMRI}/${fmriname}_hp${hp}_merge.gif))
			rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
			dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
			echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${fmriname}/${fmriname}_hp${hp}_merge.gif\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR><BR>" >> $reporthtml
		fi
	done

	# For Fmriconcat (fmriname having ICA folders)
	#Fmriconcatlist=$(for i in $StudyFolder/$Subject/MNINonLinear/Results/*/*.ica/filtered_func_data.ica/melodic_oIC.nii.gz; do $FSLDIR/bin/remove_ext $(basename $(dirname $(echo ${i%%.ica*}))); done | sort | uniq)

	for fmriname in $Fmriconcatlist ; do

		WDfMRI=$OutputFolder/Function/${fmriname}
		hps=$(for i in  $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp*.ica; do j=${i##*/}; k=${j##*_hp}; hp=${k%%.ica}; echo $hp; done)

		for hp in $hps; do
			if [ -e $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp${hp}.nii.gz ] ; then
			
				logMsg "Creating report for fmri with high-pass filtered and denoised: ${fmriname}_hp${hp}"
				mkdir -p ${WDfMRI}
				mkdir -p $OutputFolder/Function/report/${fmriname}

				echo "<a name=\"$fmriname\"><div id=\"$fmriname\"></div></a>" >> $reporthtml
				echo "<hr><B><span style=\"color:gray\">Function</span></B> - " >> $reporthtml
				for i in $Tasklist $Fmriconcatlist; do 
					if [[ $i == $fmriname ]] ; then
						echo "| <B>$i</B> " >> $reporthtml
					else
						echo "| <a href=\"#${i}\">${i}</a> " >> $reporthtml
					fi
				done
				echo "<BR><BR>" >> $reporthtml

				# Time series plot
				echo "<tr><td>High pass</td><td>$hp</td></tr>" >> $reporthtml
		    	echo "<I>Demeaned signal</I><BR>"  >> $reporthtml
			 	if [ -e $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_brain_mask.nii.gz ] ; then
					mask=$StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_brain_mask.nii.gz		
				elif [ -e $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_finalmask.nii.gz ] ; then
					mask=$StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_finalmask.nii.gz
				else
					echo "ERROR: cannnot find brain_mask for ${fmriname}"
					exit 1;
				fi
				${FSLDIR}/bin/fslmeants -i $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}.nii.gz -m $mask -o ${WDfMRI}/${fmriname}_ts.txt
				${FSLDIR}/bin/fslmeants -i $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp${hp}_clean.nii.gz -m $mask -o ${WDfMRI}/${fmriname}_hp${hp}_clean_ts.txt
				paste ${WDfMRI}/${fmriname}_ts.txt ${WDfMRI}/${fmriname}_hp${hp}_clean_ts.txt > ${WDfMRI}/${fmriname}_all_ts.txt_tmp
				${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}.nii.gz -Tmean $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_mean
				${FSLDIR}/bin/fslmaths $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp${hp}_clean.nii.gz -Tmean $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp${hp}_clean_mean

				gmeanmc=$(fslstats $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_mean.nii.gz -k $mask -m | awk '{printf "%0.6f",$1}')
				gmeancl=$(fslstats $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/${fmriname}_hp${hp}_clean_mean.nii.gz -k $mask -m | awk '{printf "%0.6f",$1}')
				cat ${WDfMRI}/${fmriname}_all_ts.txt_tmp | awk '{printf "%0.6f\t%0.6f\n",$1-'${gmeanmc}',$2-'${gmeancl}'}' > ${WDfMRI}/${fmriname}_all_ts.txt			
				matlab -nodesktop -nodisplay -r "addpath $BCILDIR/bin; bcil_tsplot('${WDfMRI}/${fmriname}_all_ts.txt','$OutputFolder/Function/report/${fmriname}/${fmriname}_all_ts.png','motion and distortion corrected','noise cleaned');exit"
				rm ${WDfMRI}/${fmriname}_ts.txt ${WDfMRI}/${fmriname}_hp${hp}_clean_ts.txt ${WDfMRI}/${fmriname}_all_ts.txt_tmp
				size=($(identify -format '%w %h' $OutputFolder/Function/report/${fmriname}/${fmriname}_all_ts.png))
				rsize=($(echo ${size[@]} | awk '{printf "1900 %d",$NF*1900/$1}'))
				dsize=($(echo ${rsize[@]} | awk '{printf "%d %d",$1*2,$2*2}'))
				echo "<div class=\"magnifier\" style=\"width: ${rsize[0]}px;height:${rsize[1]}px\"><div class=\"maglens\" style=\"width:240px; height:150px\"><img src=\"./report/${fmriname}/${fmriname}_all_ts.png\" class=\"maglarge\" style=\"width:${dsize[0]}px;height:${dsize[1]}px\"/></div></div><BR>" >> $reporthtml

				# ICA-FIX
				if [ -e $StudyFolder/$Subject/QC/ICA-FIX/${fmriname}_hp${hp}.ica ] ; then
					logMsg "Creating link to ICA-FIX report"
					echo "<I>ICA-FIX report <a href=\"../ICA-FIX/${fmriname}_hp${hp}.ica/report/0000index.html\" target=\"_blank\">(open in a new tab)</a></I><BR>" >> $reporthtml
			    		echo "The ICA-FIX report can be closely viewed by running the following command: <BR>" >> $reporthtml
		echo "<div style=\"background: ghostwhite; font-size: 12px; padding: 12px;; border: 1px solid lightgray; margin: 1px;\"<p><code> $ wb_view at $Subject/QC/ICA-FIX/${fmriname}_hp${hp}_QC.scene </code></p></div>"  >> $reporthtml
					ReclassifyAsNoise=$(cat $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/ReclassifyAsNoise.txt)
					ReclassifyAsSignal=$(cat $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/ReclassifyAsSignal.txt)
					echo "ReclassifyAsNoise: $ReclassifyAsNoise <BR>ReclassifyAsSignal: $ReclassifyAsSignal<BR><BR>"  >> $reporthtml
				fi
			
				# RestingStateStats
				if [[ -d $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/RestingStateStats ]] ; then
					logMsg "Creating report for RestingStateStats"
			    		echo "<I>RestingStateStats</I><BR>"  >> $reporthtml
					path="$(ls $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/RestingStateStats/*_OrigMGT.txt | head -1)" # MSMAll or NONE
					RSSroot=$(basename $path | sed -e 's/_OrigMGT.txt//g')
					mkdir -p $StudyFolder/$Subject/QC/Function/$fmriname
					cp -r $StudyFolder/$Subject/MNINonLinear/Results/${fmriname}/RestingStateStats $StudyFolder/$Subject/QC/Function/$fmriname/
					if [[ $(ls $StudyFolder/$Subject/QC/Function/$fmriname/*_UnstructNoise.dtseries.nii 2>/dev/null) != "" ]] ; then
						rm -rf $StudyFolder/$Subject/QC/Function/$fmriname/*_UnstructNoise.dtseries.nii
					fi

					if [ -e $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/Movement_Regressors_hp${hp}_clean.txt ] ; then
						cp $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/Movement_Regressors_hp${hp}_clean.txt $StudyFolder/$Subject/QC/Function/$fmriname/
					fi
					if [ -e  $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/Movement_Regressors_demean.txt ] ; then
						logMsg "Copying Movement_Regressors_demean.txt"
						cp $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/Movement_Regressors_demean.txt $StudyFolder/$Subject/QC/Function/$fmriname/
					elif [ -e $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/Movement_Regressors.txt ] ; then
						logMsg "Copying Movement_Regressors.txt"
						cp $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/Movement_Regressors.txt $StudyFolder/$Subject/QC/Function/$fmriname/
					fi
					cat $StudyFolder/$Subject/MNINonLinear/Results/$fmriname/${RSSroot}_stats.txt | sed -e 's/,/ /g' | awk '{ for (i=1; i<=NF; i++)  { a[NR,i] = $i } } NF>p { p = NF }END {for(j=1; j<=p; j++) { str=a[1,j]; for(i=2; i<=NR; i++){ str=str"\t"a[i,j]; } printf "%s\n", str}}' > ${WDfMRI}/RestingStateStats.tsv
					cat ${WDfMRI}/RestingStateStats.tsv | tsv2html >> $reporthtml
		   		fi
			else
		   		break;
			fi
		   
		done		
	done

	echo "<BR><BR><BR><BR><BR><BR><BR><BR></BODY></HTML>" >>  $reporthtml

fi
    
}  # end FuncQC

############################################################
# Create summary report and index html
############################################################

CreateReport () {
logMsg "Creating summary report and index html: $Subject"
WD=${StudyFolder}/${Subject}/QC/
reportdir=${WD}/report
reporthtml=${WD}/report.html
mkdir -p $reportdir

cat <<EOF > $reporthtml 
<HTML>
 <HEAD>
   <link REL="stylesheet" TYPE="text/css" href="../.files/fsl.css">
   <TITLE>HCPPIPE QC REPORT</TITLE>
   <link rel="icon" type="image/x-icon" href="../.files/favicon.ico">
   <style type="text/css">
    .button {
      display       : inline-block;
      border-radius : 20%;     
      font-size     : 8pt;    
      text-align    : center; 
      cursor        : pointer;
      padding       : 6px;
      background    : #ccc;
      color         : #000000;
      line-height   : 1em;    
      transition    : .3s;
      border: solid 1px;
      text-decoration: none;
      margin: 0px 10px;
    }
    .button.disabled {
      display       : inline-block;
      border-radius : 20%;     
      font-size     : 8pt;    
      text-align    : center; 
      cursor        : pointer;
      padding       : 6px;
      background    : #ccc;
      color         : #808B96;
      line-height   : 1em;    
      transition    : .3s;
      border: solid 1px;
      text-decoration: none;
      margin: 0px 10px;
    }
    html, body{
      overflow: hidden;
    }
    .water {
      height: 30px;
      background-color:#EBF4FA;
    }
  </style>
 </HEAD>
 <BODY BGCOLOR="#FFFFFF" TEXT="#151515">
  <center>
   <div class="water">
    <B><span style="color:gray">$Subject - </span></B>
EOF

for DIR in Structure Function Diffusion; do 
	if [ -e $WD/$DIR/report.html ] ; then
		echo "   <a target=\"Change\" href=\"./$DIR/report.html\" class=\"button\">$DIR</a>" >> $reporthtml 
	else
		echo "   <a class=\"button disabled\">$DIR</a>" >> $reporthtml 
	fi
done
cat <<EOF >> $reporthtml 
    </div>
  </center>
  <iframe frameborder="0" style="overflow:hidden; height:100%; width:100%" class="fullheight" name="Change" scrolling="auto"></iframe>
 </BODY>
</HTML>
EOF

reporthtml=${WD}/index.html
cat <<EOF > $reporthtml
<HTML>
 <HEAD>
   <link REL="stylesheet" TYPE="text/css" href=".files/fsl.css">
   <TITLE>HCPPIPE QC REPORT</TITLE>
   <link rel="icon" type="image/x-icon" href=".files/favicon.ico">
   <style type="text/css">
    html, body{
      overflow: hidden;
    }
   </style>
   <link href=".files/lightbox.css" rel="stylesheet">
   <script src=".files/jquery.min.js"></script>
   <script src=".files/lightbox.min.js" type="text/javascript"></script>
   <link type=".files/magnifier.css" rel="stylesheet">
   <script type="text/javascript" src=".files/magnifier.js"></script>
 </HEAD>
 <BODY BGCOLOR="#FFFFFF" TEXT="#151515">
  <hr>
  <img src=".files/BCIL_1.png" style="border:none; width:125px;height:50px;float:right;">
  <img src=".files/bmb.png" style="border:none; width:180px;height:50px;float:right;">
  <img src=".files/hcplogo1.jpg" style="border:none; width:150px;height:50px;float:right;">
  <img src=".files/fsl-logo-x2.png" style="border:none; width:80px;height:50px;float:right;">
  <img src=".files/freesurfer.png" style="border:none; width:100px;height:50px;float:right;">
  <B>HCPPIPE QC REPORT</B><BR>
  <FONT size=1>Version 0.1 &copy;2006-2021</FONT><BR>
  <Font size=2>Output directory: $StudyFolder/$Subject/QC </FONT><BR>
  <iframe src="./report.html" frameborder="0" style="overflow:hidden; height:100%; width:100%" class="fullheight" scrolling="no"></iframe>
 </BODY>
</HTML>
EOF
}  # end CreateReport

############################################################
# zip archive 
############################################################

ZipQC () {
# Zip QC files
if [[ $Zip = ON ]] ; then
	cd $StudyFolder
	label=""
	zipfiles="";
	if [[ $Mod =~ s ]] ; then
		if [ -e $OutputFolder/Structure/StructuralQC.scene ] ; then
			if [ -e $OutputFolder/${Subject}_QC_s.zip ] ; then
				rm $OutputFolder/${Subject}_QC_s.zip
			fi
			if [ -e $StudyFolder/$Subject/MNINonLinear/${Subject}.MyelinMap_BC_MSMAll.164k_fs_LR.dscalar.nii ] ; then
				${CARET7DIR}/wb_command -zip-scene-file $Subject/QC/Structure/StructuralQC.scene $Subject $OutputFolder/${Subject}_QC_s.zip
			fi
			zip -ru $OutputFolder/${Subject}_QC_s.zip $Subject/QC/Structure
			label=s
			zipfiles="$OutputFolder/${Subject}_QC_s.zip"
		else
		       logMsg "ERROR: cannot find strucural QC data"
		       exit 1;
		fi
	fi
	if [[ $Mod =~ f ]] ; then
		. $StudyFolder/$Subject/RawData/hcppipe_conf.txt
		lastfmriname=$(echo $Fmriconcatlist | awk -F@ '{print $NF}') 

		fmrinameziplist=""
		if [[ -z $Fmriconcatlist ]]; then
			logMsg "ERROR: cannot find Fmriconcatlist in hcppipe_conf.txt"
			exit 1
		fi
		if [ -e $StudyFolder/$Subject/QC/Function/${lastfmriname}_stats.tsv ] ; then
		

			if [ -e $OutputFolder/${Subject}_QC_f.zip ] ; then
				rm $OutputFolder/${Subject}_QC_f.zip
			fi
			for fmriname in $(echo $Fmriconcatlist | sed -e 's/@/ /g'); do
				${CARET7DIR}/wb_command -zip-scene-file $Subject/QC/Function/${fmriname}_ICA-FIX_QC.scene $Subject $OutputFolder/${Subject}_QC_f_${fmriname}.zip
				fmrinameziplist="$fmrinameziplist $OutputFolder/${Subject}_QC_f_${fmriname}.zip"
			done
			if [[ $(echo $fmrinameziplist | wc -w) -gt 1 ]] ; then
				zipmerge $OutputFolder/${Subject}_QC_f.zip $fmrinameziplist
			elif [[ $(echo $fmrinameziplist | wc -w) -eq 1 ]] ; then
				mv $fmrinameziplist $OutputFolder/${Subject}_QC_f.zip
			fi
			zip -ru $OutputFolder/${Subject}_QC_f.zip $Subject/QC/Function
			label+=f
			zipfiles+=" $OutputFolder/${Subject}_QC_f.zip"
		else
		       logMsg "Warning: cannot find functional QC data"
		fi
	fi
	
	if [[ $Mod =~ F ]] ; then
		if [ -e $OutputFolder/Fieldmap/qc.tsv ] ; then
			if [ -e $OutputFolder/${Subject}_QC_F.zip ] ; then
				rm $OutputFolder/${Subject}_QC_F.zip
			fi
			zip -r $OutputFolder/${Subject}_QC_F.zip $Subject/QC/Fieldmap
			label+=F
			zipfiles+=" $OutputFolder/${Subject}_QC_F.zip"
		else
		       logMsg "Warning: cannot find fieldmap QC data"			
		fi
	fi
	if [[ $Mod =~ d ]] ; then
		if [ -e $OutputFolder/${Subject}_QC_d.zip ] ; then
			rm $OutputFolder/${Subject}_QC_d.zip
		fi
		zip -r $OutputFolder/${Subject}_d.zip $Subject/QC/Diffusion
		label+=d
		zipfiles+=" $OutputFolder/${Subject}_QC_d.zip"
	fi

	# Zip archive for QC data
	if [[ $ZipMerge = ON ]] ; then
		logMsg "Merging zip files"
		label=""; zipfiles="";
		if [ -e $OutputFolder/${Subject}_QC_s.zip ] ; then
			zipfiles="$OutputFolder/${Subject}_QC_s.zip"
			label=s
		fi
		if [ -e $OutputFolder/${Subject}_QC_f.zip ] ; then
			zipfiles+=" $OutputFolder/${Subject}_QC_f.zip"
			label+=f
		fi
		if [ -e $OutputFolder/${Subject}_QC_F.zip ] ; then
			zipfiles+=" $OutputFolder/${Subject}_QC_F.zip"
			label+=F
		fi
		if [ -e $OutputFolder/${Subject}_QC_d.zip ] ; then
			zipfiles+=" $OutputFolder/${Subject}_QC_d.zip"
			label+=d
		fi
		if [ -e $OutputFolder/${Subject}_QC_t.zip ] ; then
			zipfiles+=" $OutputFolder/${Subject}_QC_t.zip"
			label+=t
		fi
		if [ -z $label ] ; then
			logMsg "Warning: no zip files found"
		elif [ $(echo $zipfiles | wc -w) -lt 1 ] ; then
			if [ -e $OutputFolder/${Subject}_QC_${label}.zip ] ; then
				rm $OutputFolder/${Subject}_QC_${label}.zip
			fi
			zipmerge $OutputFolder/${Subject}_QC_${label}.zip $zipfiles
			rm $zipfiles
		fi
	fi
fi
} # end ZipQC

############################################################
# Write QC metrics in .tsv and .json
############################################################

WriteMetrics () {
	# Create wide qc_metrics.tsv and qc_metrics.json under $OutputFolder
	# Output rows:
	#  - Structure: one row (Run=Structural)
	#  - Diffusion: one row (Run=Diffusion)
	#  - Function: one row per fmriname directory (Run=fmriname)
	logMsg "Writing qc_metrics.tsv / qc_metrics.json"

	out_tsv="${OutputFolder}/qc_metrics.tsv"
	out_json="${OutputFolder}/qc_metrics.json"

	# Metric definitions (kept consistent with hcppipe_gqc varname rules)
	struct_varsets="brainmask_fs_MEAN@T1w_acpc_dc_stats.tsv@2@-x brainmask_fs_MEAN@T2w_acpc_dc_stats.tsv@2@-x brainmask_fs_MEAN@T1wmulT2w_stats.tsv@2@-x brainmask_fs_MEAN@T1wDividedByT2w_stats.tsv@2@-x FSL_BBR_mincost@T2wToT1w.mincost.tsv@2@-x FreeSurfer_BBR_mincost@T2wToT1w.mincost.tsv@2@-x T1wmulT2w_brain_norm_modulate_mask_ratio@T1wmulT2w_brain_norm_modulate_stats.tsv@2@-x Q2@BiasField_acpc_dc_stats.tsv@2@-x IQR@BiasField_acpc_dc_stats.tsv@2@-x IQR@Fieldmap_stats.tsv@2@-x Myelin_Biasfield_Q2@SurfaceStats.tsv@2@-x Myelin_Biasfield_IQR@SurfaceStats.tsv@2@-x Myelin_Biasfield_Asymmetry_Q2@SurfaceStats.tsv@2@-x Myelin_Biasfield_Asymmetry_IQR@SurfaceStats.tsv@2@-x MSMSulc_areal_distortion_IQR@SurfaceStats.tsv@2@-x MSMAll_areal_distortion_IQR@SurfaceStats.tsv@2@-x MyelinMap_similarity@SurfaceStats.tsv@2@-x MyelinMap_BC_similarity@SurfaceStats.tsv@2@-x thickness_similarity@SurfaceStats.tsv@2@-x SDS5@SurfaceStats.tsv@2@-c Q2@NonlinearRegJacobians_stats.tsv@2@-x IQR@NonlinearRegJacobians_stats.tsv@2@-x"
	func_varsets="Movement_AbsoluteRMS_mean@Movement_AbsoluteRMS_mean.txt@1@1@-x Movement_RelativeRMS_mean@Movement_RelativeRMS_mean.txt@1@1@-x Q2@Movement_Regressors_FD_stats.txt@2@3@-x PercOutlier@ICA-FIX_stats.tsv@2@3@-x Dvar-SvarDivergence@ICA-FIX_stats.tsv@3@3@-x AutocorrCoeffMedian@ICA-FIX_stats.tsv@4@3@-x FSL_BBR@EPI2T1w.mincost.tsv@2@1@-x FreeSurfer_BBR@EPI2T1w.mincost.tsv@2@2@-x IQR@Fieldmap_stats.tsv@2@7@-x NumSignal@RestingStateStats.tsv@2@2@-c NumNoise@RestingStateStats.tsv@2@3@-c NumTotal@RestingStateStats.tsv@2@4@-c CNR@RestingStateStats.tsv@2@16@-x HighPassVarRatio@RestingStateStats.tsv@2@25@-x MotionVar@RestingStateStats.tsv@2@11@-x StructNoiseVar@RestingStateStats.tsv@2@12@-x BOLDVar@RestingStateStats.tsv@2@13@-x UnstructNoiseVar@RestingStateStats.tsv@2@14@-x TSNR@RestingStateStats.tsv@2@8@-x MotionVarRatio@RestingStateStats.tsv@2@26@-x StructNoiseVarRatio@RestingStateStats.tsv@2@27@-x BOLDVarRatio@RestingStateStats.tsv@2@28@-x UnstructNoiseVarRatio@RestingStateStats.tsv@2@29@-x"
	diff_varsets="SNR@DiffusionQC.tsv@2@-x CNR@DiffusionQC.tsv@2@-x motion@DiffusionQC.tsv@2@-x outliers@DiffusionQC.tsv@2@-x displacement@DiffusionQC.tsv@2@-x IQR@Fieldmap_stats.tsv@2@-x Fiber_1_ratio@TractographyQC.tsv@2@-x Fiber_2_ratio@TractographyQC.tsv@2@-x Fiber_3_ratio@TractographyQC.tsv@2@-x Fiber_1_uncertainty@TractographyQC.tsv@2@-x Fiber_2_uncertainty@TractographyQC.tsv@2@-x Fiber_3_uncertainty@TractographyQC.tsv@2@-x FSL_BBR_mincost@nodif2T1w.mincost.tsv@2@-x FreeSurfer_BBR_mincost@nodif2T1w.mincost.tsv@2@-x"

	# Build header
	metrics=""
	for varset in $struct_varsets ; do
		varkey=$(echo "$varset" | cut -d '@' -f 1)
		file=$(echo "$varset" | cut -d '@' -f 2)
		filebase="${file%.tsv}"; filebase="${filebase%.txt}"
		varname="sMRI_${filebase}_${varkey}"
		metrics="${metrics}	${varname}"
	done
	for varset in $diff_varsets ; do
		varkey=$(echo "$varset" | cut -d '@' -f 1)
		file=$(echo "$varset" | cut -d '@' -f 2)
		filebase="${file%.tsv}"; filebase="${filebase%.txt}"
		varname="dMRI_${filebase}_${varkey}"
		metrics="${metrics}	${varname}"
	done
	for varset in $func_varsets ; do
		varkey=$(echo "$varset" | cut -d '@' -f 1)
		file=$(echo "$varset" | cut -d '@' -f 2)
		filebase="${file%.tsv}"; filebase="${filebase%.txt}"
		varname="fMRI_${filebase}_${varkey}"
		metrics="${metrics}	${varname}"
	done

	echo -e "SubjectID	Modality	Run${metrics}" > "$out_tsv"

	# Helper: get value from a tsv/txt using grep varkey (Structure/Diffusion style)
	_get_grep_val () {
		local file="$1"
		local key="$2"
		local col="$3"
		if [ -e "$file" ] ; then
			# tail -1 to match gqc behavior for repeated keys
			{ grep -F "$key" "$file" 2>/dev/null || true; } | tail -1 | awk -F "	" '{print $'"$col"'}'
		else
			echo ""
		fi
	}

	# Helper: get value by row/col (Function/RestingStateStats style)
	_get_rc_val () {
		local file="$1"
		local row="$2"
		local col="$3"
		if [ -e "$file" ] ; then
			awk -F "\t" 'NR=='"$row"' {print $'"$col"'}' "$file"
		else
			echo ""
		fi
	}

	# --- Structure row ---
	if [ -d "${OutputFolder}/Structure" ] ; then
		logMsg "adding Structure to qc_metrics.tsv"
		row="${Subject}\tStructure\tStructure"
		for varset in $struct_varsets ; do
			varkey=$(echo "$varset" | cut -d '@' -f 1)
			file=$(echo "$varset" | cut -d '@' -f 2)
			col=$(echo "$varset" | cut -d '@' -f 3)
			val=$(_get_grep_val "${OutputFolder}/Structure/${file}" "${varkey}" "${col}")
			row="${row}\t${val}"
		done
		# pad diffusion metrics
		for varset in $diff_varsets ; do row="${row}\t"; done
		# pad function metrics
		for varset in $func_varsets ; do row="${row}\t"; done
		echo -e "$row" >> "$out_tsv"
	fi

	# --- Diffusion row ---
	if [ -d "${OutputFolder}/Diffusion" ] ; then
		logMsg "adding Diffusion to qc_metrics.tsv"
		row="${Subject}\tDiffusion\tDiffusion"
		# pad structure metrics
		for varset in $struct_varsets ; do row="${row}\t"; done
		for varset in $diff_varsets ; do
			varkey=$(echo "$varset" | cut -d '@' -f 1)
			file=$(echo "$varset" | cut -d '@' -f 2)
			col=$(echo "$varset" | cut -d '@' -f 3)
			val=$(_get_grep_val "${OutputFolder}/Diffusion/${file}" "${varkey}" "${col}")
			row="${row}\t${val}"
		done
		# pad function metrics
		for varset in $func_varsets ; do row="${row}\t"; done
		echo -e "$row" >> "$out_tsv"
	fi

	# --- Function rows ---
	if [ -d "${OutputFolder}/Function" ] ; then
		logMsg "adding Function to qc_metrics.tsv"
		for runpath in ${OutputFolder}/Function/* ; do
			fmriname=$(basename "$runpath")
			if [ -d "$runpath" ] && [ "$fmriname" != "report" ] ; then
				row="${Subject}\tFunction\t${fmriname}"
				# pad structure metrics
				for varset in $struct_varsets ; do row="${row}\t"; done
				# pad diffusion metrics
				for varset in $diff_varsets ; do row="${row}\t"; done
				for varset in $func_varsets ; do
					varkey=$(echo "$varset" | cut -d '@' -f 1)
					file=$(echo "$varset" | cut -d '@' -f 2)
					col=$(echo "$varset" | cut -d '@' -f 3)
					rownum=$(echo "$varset" | cut -d '@' -f 4)
					# Special case: file is inside each run folder
					val=$(_get_rc_val "${runpath}/${file}" "${rownum}" "${col}")
					row="${row}\t${val}"
				done
				echo -e "$row" >> "$out_tsv"
			fi
		done
	fi

	# --- JSON export (same content + meta) ---
	logMsg "Converting qc_metrics.tsv to qc_metrics.json"
	tmpjson="${OutputFolder}/.qc_metrics_rows.jsonl"
	awk -F "\t" '
	NR==1 { for(i=1;i<=NF;i++){h[i]=$i} ; next }
	{
		printf "{";
		for(i=1;i<=NF;i++){
			v=$i;
			gsub(/\\/,"\\\\",v);
			gsub(/"/,"\\\"",v);
			printf "\"%s\":\"%s\"%s", h[i], v, (i==NF?"":",");
		}
		print "}";
	}
	' "$out_tsv" > "$tmpjson"

	if command -v jq >/dev/null 2>&1 ; then
  	# Derive modalities from TSV header (wide format: fMRI_*, dMRI_*, sMRI_*)
	modalities=$(head -n 1 "$out_tsv" | tr '\t' '\n' \
	| awk -F_ 'tolower($1) ~ /^(fmri|dmri|smri)$/ {print tolower($1)}' \
	| sort -u | paste -sd, -) : "${modalities:=unknown}"

	jq -n \
	--arg subject "$Subject" \
	--arg generated_at "$(date -Iseconds)" \
	--arg script "hcppipe_qc" \
	--arg version "${VERSION:-unknown}" \
	--arg modalities "$modalities" \
	--slurpfile rows "$tmpjson" \
	'{meta:{subject:$subject, generated_at:$generated_at, script:$script, version:$version, modalities:$modalities}, rows:$rows}' \
	> "$out_json"
else
	# Fallback: JSON Lines only
	cp "$tmpjson" "$out_json"
fi
	rm -f "$tmpjson"
} # end WriteMetrics


StrucQC;
DiffQC;
ICAFIXQC;
FuncQC;
WriteMetrics;
CreateReport;
ZipQC;

logMsg "Finished hcppipe_qc!"

exit 0;
