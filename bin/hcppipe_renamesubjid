#! /bin/bash

Usage () {
echo ""
echo " Usage: $0 <path to SubjectID to be renamed> <path to New SubjectID>"
echo ""
exit 1;
}
[ "$2" = "" ] && Usage

SubjectIDOld=`basename $1`
SubjectIDNew=`basename $2`
SubjectDirOld=`dirname $(readlink -f $1)`
SubjectDirNew=`dirname $(readlink -f $2)`
TMP=tmp_$$
CARET7DIR=/mnt/temp_data1/HCP/workbench-dev/workbench/bin

if [ -e $SubjectIDNew ] ; then
	echo "Warining: $SubjectIDNew already exits. Change to ${SubjectIDNew}+"
	SubjectIDNew=${SubjectIDNew}+
fi

if [ ! -w $SubjectDirNew ] ; then
	echo "ERROR: don't have permission to create a new subject directory"
	exit 1;
fi

#####################
# run
#####################
cd $SubjectDirOld
mkdir -p "$SubjectDirNew"/"$SubjectIDNew"

# copy directories
cd $SubjectIDOld
for dir in $(find . -depth -type d -name "*") ; do 
	echo "renamig $dir -> ${SubjectDirNew}/${SubjectIDNew}/${dir//$SubjectIDOld/$SubjectIDNew}"
	mkdir -p ${SubjectDirNew}/${SubjectIDNew}/${dir//"$SubjectIDOld"/"$SubjectIDNew"}
	touch -r $dir ${SubjectDirNew}/${SubjectIDNew}/${dir//"$SubjectIDOld"/"$SubjectIDNew"}
done

# copy files
cd $SubjectDirOld
for file in $(find $SubjectIDOld -depth -type f -name "*") ; do 
	echo "renaming $file -> ${SubjectDirNew}/${file//"$SubjectIDOld"/"$SubjectIDNew"}"
	cp -a $file ${SubjectDirNew}/${file//"$SubjectIDOld"/"$SubjectIDNew"}
done

# copy links
for link in $(find $SubjectIDOld -depth -type l -name "*") ; do 
	echo "renaming $link -> ${SubjectDirNew}/${link//"$SubjectIDOld"/"$SubjectIDNew"}"
	cp -a $link ${SubjectDirNew}/${link//"$SubjectIDOld"/"$SubjectIDNew"}
done

# recreate spec, scene, .dat and .lta files
cd $SubjectDirNew
for file in $(find $SubjectIDNew -depth -type f -name "*.scene" -o -name "*.spec" -o -name "*.dat" -o -name "*.lta") ; do
	echo "recreating $file"
	cat $file | sed -e 's/'$SubjectIDOld'/'$SubjectIDNew'/g' > "${TMP}"
	touch -r $file "${TMP}"
	mv "${TMP}" $file
done

# rename subjid in the provenance of cifti files
for ext in surf.gii func.gii shape.gii dscalar.gii dtseries.nii dconn.nii dlabel.nii pconn.nii pdconn.nii dpconn.nii pscalar.nii ptseries.nii ; do
	find $SubjectIDNew -depth -name "*.$ext" -execdir bash -c 'file=$(readlink -f $1); echo "updating provenance of $file"; '$CARET7DIR'/wb_command -metadata-string-replace $file '$SubjectIDOld' '$SubjectIDNew' '${TMP}${ext}'; touch -r $file '${TMP}${ext}'; mv '${TMP}${ext}' $file' bash {} \; ;
done

# record old subject ID
if [ ! -d ${SubjectIDNew}/RawData ] ; then
	mkdir -p ${SubjectIDNew}/RawData
fi
echo $SubjectIDOld > ${SubjectIDNew}/RawData/SubjectIDOld.txt

echo Finished!

